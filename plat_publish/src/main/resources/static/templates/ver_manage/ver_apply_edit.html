<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>版本申请</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" type="text/css" href="../../layui-v2.5.6/layui/css/layui.css">
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
</head>
<style type="text/css">
	.layui-textarea{
		width:81%;
	}
	.layui-required:after{
        content:"*";
        color:red;
        position: absolute;
    }
</style>
<body>
 
<form class="layui-form" action="" style="margin-top:50px">
  <div class="layui-form-item">
    <label class="layui-form-label layui-required">项目名称</label>
    <div class="layui-input-block ">
      <input type="text" name="projName" id="projName" lay-verify="required"   class="layui-input" style="width:81%">
      <input type="hidden" name="projName" id="flowNo"    class="layui-input" >
    </div>
  </div>
  
   <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label layui-required">产品线</label>
      <div class="layui-input-inline">
        <select lay-verify="required" id="deptId" lay-search="">
			<option value="">选择或搜索</option>
			<option value="134">产品一部</option>
			<option value="132">产品二部</option>
			<option value="133">产品三部</option>
			<option value="135">产品四部</option>
			<option value="162">产品五部</option>
			<option value="136">派科斯</option>
			<option value="155">软件部</option>
		</select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label ">客户名称</label>
      <div class="layui-input-inline">
        <select  id="client" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required" style="width:84px">被测产品大类</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" id="product" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required">料号</label>
      <div class="layui-input-inline">
      <input type="text" name="subPartNo" lay-verify="required"
						id="subPartNo" autocomplete="off" class="layui-input">
      </div>
    </div>
  </div>
   <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label layui-required">测试类型</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" id="testType" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline" >
      <label class="layui-form-label layui-required">版本类型</label>
      <div class="layui-input-inline">
        <select name="verType" lay-filter="verType" lay-verify="required" id="verType" lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">正式版本</option>
          <option value="2">临时版本</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required">版本层级</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" id="verlevel" lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">产品</option>
		  <option value="2">上位机</option>
		  <option value="3">下位机</option>
		  <option value="4">模块</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required">版本包属性</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" id="pkgType" lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">完整版本</option>
		  <option value="2">补丁版本</option>
        </select>
      </div>
    </div>
  </div>
  
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label layui-required">软件名称</label>
      <div class="layui-input-inline">
        <input type="text" name="verId" id="verId" lay-verify="required" id="cfgManager" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required">版本号</label>
      <div class="layui-input-inline">
        <input type="text" name="verNo" id="verNo" lay-verify="required" id="cfgManager" autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label layui-required">配置管理员</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" id="cfgManager" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline" id="test">
      <label class="layui-form-label layui-required">测试负责人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" name="testManager" id="testManager" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline" id="approval" style="display:none">
      <label class="layui-form-label layui-required" >版本审批人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" name="appManager" id="testManager1" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
  <div class="layui-form-item layui-form-text">
    <label class="layui-form-label layui-required">版本描述</label>
    <div class="layui-input-block">
      <textarea id="verInfo" placeholder="简要说明版本描述" class="layui-textarea" ></textarea>
    </div>
  </div>
  
  <div class="layui-form-item layui-form-text" id="tarea_b">
    <label class="layui-form-label layui-required">版本构建说明</label>
    <div class="layui-input-block">
      <textarea placeholder="应说明版本包由哪些部分组成，每一部分从哪里以何种方式获取" id="buildInfo" class="layui-textarea"> </textarea>
    </div>
  </div>
  
  <div class="layui-form-item layui-form-text" id="tarea_r" style="display:none">
    <label class="layui-form-label">临时版本申请原因</label>
    <div class="layui-input-block">
      <textarea placeholder="说明申请临时版本原因" class="layui-textarea" id="tempInfo" ></textarea>
    </div>
  </div>
 
  <div class="layui-form-item">
    <div class="layui-input-block">
      <button type="button" class="layui-btn layui-btn-danger" id="delete">删除</button>
      <!-- <button type="button" class="layui-btn layui-btn-normal"  id="save">保存</button> -->
      <button type="submit" class="layui-btn"  id="build" >申请构建</button>
      <button type="submit" class="layui-btn"  id="approve" style="display:none" >申请审批</button> 
    </div>
  </div>
</form>
<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
//保存的请求
 function reqSave(){
	var data = redata('save');
	var flowNo  = $('#flowNo').val();
	$.ajax({
		url:'/versions/'+flowNo,
		type:'put',
		beforeSend:function(request){
			request.setRequestHeader("Authorization","Bearer "+token);
		},
		data:JSON.stringify(data),
		dataType:'json',
		contentType:"application/json;charset=UTF-8",
		success:function(data){
			if(data.status == 200){
				top.layer.msg('保存成功', {icon: 1,time:800,end: function () {
	    			var index = parent.layer.getFrameIndex(window.name);
	            	parent.layer.close(index);}
	    		});
			}else{
				top.layer.msg('保存失败');
			}
		}
		,error:function(){
			layer.msg(msg);
		}
	});
}
//申请审批或者构建的请求
 function reqApply(){
	var flowNo = $('#flowNo').val();
	var verType = $('#verType').val();
	if(verType == '1'){
		data = redata('apply');
	}else{
		data = redata('approve');
	}
	$.ajax({
		url:'/versions/'+flowNo+'/apply',
		type:'put',
		async:false,
		beforeSend:function(request){
			request.setRequestHeader("Authorization","Bearer "+token);
		},
		data:JSON.stringify(data),
		contentType:'application/json;charset=UTF-8',
		dataType:'json',
		success:function(data){
			if(data.status == 200){
				top.layer.msg('申请成功',{icon:1,time:800})
			 	window.parent.location.reload();
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			}else{
				top.layer.msg('申请失败');
			}
		}
		,error:function(){
			top.layer.msg('出错了');
		}
	});
}

//删除的请求
function reqDel(){
	var flowNo = $('#flowNo').val();
	layer.confirm('确定删除这个申请吗', function(index){
		$.ajax({
			url:'/versions/'+flowNo,
			type:'delete',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			dataType:'json',
			success:function(res){
				if(res.status == 200){
					top.layer.msg('删除成功', {icon: 1,time:800,end: function () {
						window.parent.location.reload();
		    			var index = parent.layer.getFrameIndex(window.name);
		            	parent.layer.close(index);}
		    		});
				}else{
					top.layer.msg('删除失败，请重试');
					return;
				}
			}
		})
    });
}

$('#approve').click(function(){
	 if(!required()){
		return;
	} 
	reqApply();
});
$('#build').click(function(){
	  if(!required()){
		return;
	} 
	reqApply(); 
});
$('#save').click(function(){
	 var flag = required();
	if(!flag){
		return;
	} 
	reqSave();
});
$('#delete').click(function(){
	reqDel();
});

function initData(data){
	layui.use('form',function(){
		var form = layui.form;
		var flowNo = data.flowNo;
		var projName = data.projName;
		var deptId = data.deptId;
		var client = data.client;
		var product = data.product;
		var subPartNo = data.subPartNo;
		var testType = data.testType;
		var verType = data.verType;
		var verlevel = data.verlevel;
		var pkgType = data.pkgType;
		var verNo = data.verNo;
		var verId = data.verId;
		var verInfo = data.verInfo;
		var buildInfo = data.buildInfo;
		var tempInfo = data.tempInfo;
		var cfgManager = data.cfgManager;
		var testManager = data.testManager;
		$('#flowNo').val(flowNo);
		$('#projName').val(projName);
		$('#product').val(product);
		$('#deptId').val(deptId);
		$('#client').val(client);
		$('#subPartNo').val(subPartNo);
		$('#testType').val(testType);
		$('#verType').val(verType);
		$('#verlevel').val(verlevel);
		$('#pkgType').val(pkgType);
		$('#verNo').val(verNo);
		$('#verId').val(verId);
		$('#verInfo').val(verInfo);
		$('#buildInfo').val(buildInfo);
		$('#tempInfo').val(tempInfo);
		$.ajax({
			url:'/versions/users',
			type:'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			async:false,
			dataType:'json',
			success:function(res){
				for(var i=0; i<res.data.length; i++){ 
					if (cfgManager ==res.data[i].id ){
		    			$("#cfgManager").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"</option>"); 
		    		}else{
		    	       $("#cfgManager").append("<option value='"+res.data[i].id+"'>"+res.data[i].realname+"</option>");
		    		}
					if (testManager ==res.data[i].id ){
		    			$("#testManager").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"</option>"); 
		    		}else{
		    	       $("#testManager").append("<option value='"+res.data[i].id+"'>"+res.data[i].realname+"</option>");
		    		}
					if (testManager ==res.data[i].id ){
		    			$("#testManager1").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"</option>"); 
		    		}else{
		    	       $("#testManager1").append("<option value='"+res.data[i].id+"'>"+res.data[i].realname+"</option>");
		    		}
		    	}
				form.render('select');
			}
		});
		form.render();
		$.ajax({
			url : '/versions/erpDict',
			type : 'get',
			beforeSend : function(request) {
				request.setRequestHeader("Authorization", "Bearer "
						+ token);
			},
			async : false,
			dataType : 'json',
			success : function(res) {
				var data = res.data;
				for (var i = 0; i < data.length; i++) {
					if (data[i].type == 'product') {
						if (data[i].code == product) {
							$("#product").append(
									"<option value='"+product+"' selected>"
											+ product + "</option>");
						} else {
							$("#product").append(
									"<option value='"+data[i].code+"'>"
											+ data[i].code
											+ "</option>");
						}
					} else if (data[i].type == 'test') {
						var test1 = data[i].code + " " + data[i].name
						if (test1 == testType.trim()) {
							$("#testType").append(
									"<option value='"+testType+"' selected>"
											+ testType + "</option>");
						} else {
							$("#testType").append(
									"<option value='"+data[i].code+" "+data[i].name+"'>"
											+ data[i].code + " "
											+ data[i].name
											+ "</option>");
						}
					} else {
						var client1 = data[i].code + " " + data[i].name
						if (client1 == client.trim()) {
							$("#client").append(
									"<option value='"+client+"' selected>"
											+ client + "</option>");
						} else {
							$("#client").append(
									"<option value='"+data[i].code+" "+data[i].name+"'>"
											+ data[i].code + " "
											+ data[i].name
											+ "</option>");
						}
					}
				}
				form.render('select');
			}
		});
	  if(verType == '1'){
		  $('#test').removeClass('layui-hide');
		  $('#test').attr('diplay','inline-block');
		  $('#approval').addClass('layui-hide');
		  $('#tarea_r').addClass('layui-hide');
		  $('#build').removeClass('layui-hide');
		  $('#build').attr('diplay','inline-block');
		  $('#approve').addClass('layui-hide');
		  $('#approval').find('select[name="appManager"]').removeAttr('lay-verify');
		  $('#test').find('select[name="testManager"]').attr('lay-verify','required');
		  $('#test').find('select[name="testManager"]').val(testManager);
		  $('#approval').find('select[name="appManager"]').val('');
	  }else{
		  $('#test').addClass('layui-hide');
		  $('#approval').removeClass('layui-hide');
		  $('#approval').css('display','inline-block');
		  $('#tarea_r').removeClass('layui-hide');
		  $('#tarea_r').css('display','block');
		  $('#build').addClass('layui-hide');
		  $('#approve').removeClass('layui-hide');
		  $('#approve').css('display','inline-block');
		  $('#approval').find('select[name="appManager"]').attr('lay-verify','required');
		  $('#approval').find('select[name="appManager"]').val(testManager);
		  $('#test').find('select[name="testManager"]').val('');
		  $('#test').find('select[name="testManager"]').removeAttr('lay-verify');  
	  }  
	});
	
}

function  required(){
	var projName = $('#projName').val();         
	var product = $('#product').val();         
	var subPartNo = $('#subPartNo').val();         
	var testType = $('#testType').val();         
	var verType = $('#verType').val();         
	var deptId = $('#deptId').val();         
	var client = $('#client').val();         
	var verlevel = $('#verlevel').val();         
	var pkgType = $('#pkgType').val();         
	var verId = $('#verId').val();         
	var verNo = $('#verNo').val();         
	var cfgManager = $('#cfgManager').val();         
	var verInfo = $('#verInfo').val();         
	var buildInfo = $('#buildInfo').val();         
	var test = $('#test').find('select[name="testManager"]').val();
	var app = $('#approval').find('select[name="appManager"]').val();
	var testManager = '';
	if(test == undefined ||　test == ''){
		testManager = app;
	}else{
		testManager = test;
	}
    if(projName == undefined || projName == ''){
    	return false;
    }
    if(product == undefined || product == ''){
    	return false;
    }
    if(subPartNo == undefined || subPartNo == ''){
    	return false;
    }
    if(testType == undefined || testType == ''){
    	return false;
    }
    if(verType == undefined || verType == ''){
    	return false;
    }
    if(deptId == undefined || deptId == ''){
    	return false;
    }
    if(pkgType == undefined || pkgType == ''){
    	return false;
    }
    if(verId == undefined || verId == ''){
    	return false;
    }
    if(cfgManager == undefined || cfgManager == ''){
    	return false;
    }
    if(testManager == undefined || testManager == ''){
    	return false;
    }
    if(verNo == undefined || verNo == ''){
    	return false;
    }
    if(verInfo == undefined || verInfo == ''){
    	return false;
    }
	if(buildInfo == undefined || buildInfo == ''){
	  return false;
	}
    return true;
}

function redata(str){
	var projName = $('#projName').val();         
	var product = $('#product').val();         
	var subPartNo = $('#subPartNo').val();         
	var testType = $('#testType').val();         
	var verType = $('#verType').val();         
	var deptId = $('#deptId').val();         
	var client = $('#client').val();         
	var verlevel = $('#verlevel').val();         
	var pkgType = $('#pkgType').val();         
	var verId = $('#verId').val();         
	var verNo = $('#verNo').val();         
	var cfgManager = $('#cfgManager').val();         
	var verInfo = $('#verInfo').val();         
	var test = $('#test').find('select[name="testManager"]').val();
	var app = $('#approval').find('select[name="appManager"]').val();
	var buildInfo = $('#buildInfo').val();
	var tempInfo = $('#tempInfo').val();
	if(verType == '1'){
		var name = 'Apply';
		var result = 2;
	}else{
		var name = 'Approve';
		var result = 5;
	}
	if(test == undefined ||　test == ''){
		testManager = app;
	}else{
		testManager = test;
	}
	if(str == 'save'){
	  var data = {projName:projName,product:product,subPartNo:subPartNo,testType:testType,verType:verType,deptId:deptId,builder:cfgManager,
				    client:client,verlevel:verlevel,pkgType:pkgType,verId:verId,verNo:verNo,cfgManager:cfgManager,testManager:testManager,
				    verInfo:verInfo,buildInfo:buildInfo,tempInfo:tempInfo,status:1}; 
	}else if(str == 'apply'){
      var data = {projName:projName,product:product,subPartNo:subPartNo,testType:testType,deptId:deptId,client:client,
			    verlevel:verlevel,pkgType:pkgType,verId:verId,verNo:verNo,cfgManager:cfgManager,testManager:testManager,
			    verInfo:verInfo,buildInfo:buildInfo,tempInfo:tempInfo,verType:verType,status:2,
			    name:name,result:result,cfgManager:cfgManager,builder:cfgManager};
	}else{
	  var data = {projName:projName,product:product,subPartNo:subPartNo,testType:testType,deptId:deptId,client:client,
			    verlevel:verlevel,pkgType:pkgType,verId:verId,verNo:verNo,cfgManager:cfgManager,testManager:testManager,
			    verInfo:verInfo,buildInfo:buildInfo,tempInfo:tempInfo,verType:verType,status:5,
			    name:name,result:result,testManager:testManager,builder:cfgManager};
	}
	return data;
}

 layui.use('form', function(){
  var form = layui.form;
  form.on('select(verType)',function(data){
	  if(data.value == undefined || data.value == ''){
		  return;
	  }
	  if(data.value == '1'){
		  $('#test').removeClass('layui-hide');
		  $('#test').attr('diplay','inline-block');
		  $('#approval').addClass('layui-hide');
		  $('#tarea_r').addClass('layui-hide');
		  $('#build').removeClass('layui-hide');
		  $('#build').attr('diplay','inline-block');
		  $('#approve').addClass('layui-hide');
		  $('#approval').find('select[name="appManager"]').removeAttr('lay-verify');
		  $('#test').find('select[name="testManager"]').attr('lay-verify','required');
		  $('#approval').find('select[name="appManager"]').val('');
		  $('#tempInfo').val('');
	  }else{
		  $('#test').addClass('layui-hide');
		  $('#approval').removeClass('layui-hide');
		  $('#approval').css('display','inline-block');
		  $('#tarea_r').removeClass('layui-hide');
		  $('#tarea_r').css('display','block');
		  $('#build').addClass('layui-hide');
		  $('#approve').removeClass('layui-hide');
		  $('#approve').css('display','inline-block');
		  $('#approval').find('select[name="appManager"]').attr('lay-verify','required');
		  $('#test').find('select[name="testManager"]').removeAttr('lay-verify');  
		  $('#test').find('select[name="testManager"]').val('');
	  }  
  })
 }); 
 
 function closeBtn(){
	    top.layer.msg('申请成功',{time:800})
	 	window.parent.location.reload();
		var index = parent.layer.getFrameIndex(window.name);
		parent.layer.close(index);
	}
</script>


</body>
</html>