<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<title>版本文件下载</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" type="text/css"href="../../layui-v2.5.6/layui/css/layui.css">
<script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
<script src="/static/js/common.js" charset="utf-8"></script>
</head>
<body>

	<form class="layui-form" action="" style="margin-top: 20px">

		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">操作说明</label>
			<div class="layui-input-block">
				<textarea placeholder="文档齐套性检查;版本说明，测试报告，版本安装指导书文档是否齐全;国外客户是否支持英文"
					class="layui-textarea" id="comment"></textarea>
			</div>
		</div>

	</form>

	<table class="layui-table" lay-filter="check" id="test">
	</table>
	<div class="layui-input-block">
			<button type="submit" class="layui-btn" id="download">下载</button>
			<button type="button" class="layui-btn layui-btn-primary" id="closeIframe">返回</button>
	</div>
	<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn layui-btn" lay-event="deal">下载</a>
</script>
	<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
	<script>
		var storage = window.localStorage;
		var token = storage.getItem("token");
		var flowNo = '';
		var files = [];
		var type = '';
		var data = {};
		function initData(data) {
			flowNo = data.flowNo;
			layui.use('table', function() {
				var table = layui.table;
				table.render({
					id : 'test',
					elem : '#test',
					headers : {
						Authorization : "Bearer " + token
					},
					url : '/versions/' + flowNo + '/files',
					parseData:function(res){ 
			        	return parseData(res); //common.js里面
			        },
					cols : [ [ {
						field : '',
						fixed : true,
						align : 'center',
						type : 'checkbox',
						style : 'background:#efe1e1;'
					}, {
						field : 'fileName',
						title : '文件名'
					}, {
						field : '',
						title : '大小',
						templet : function(d) {
							if(d.size>1024){
								return Math.round(d.size/1024) + " M"
							}
							return d.size + " kb";
						}
					}, {
						field : 'editTime',
						title : '修改日期',
						templet : function(d) {
							return dateFormat(d.editTime);
						}
					} ] ]
				});
			});
		}
		$('#reset').click(function() {
			$('#comment').val('');
		})
		 $('#download').click(function() {
			 $.ajax({
				 url:'/versions/getCurrenter',
				 type:'get',
				 beforeSend:function(request){
			 			request.setRequestHeader("Authorization","Bearer "+token);
			 	 },
				 dataType:'json',
				 success:function(res){
					 if(res.msg == 'success'){
						var currenter = res.data;
						layui.use('table',function(){
							var table = layui.table;
							var dowdata = table.checkStatus('test');
							for(var i = 0;i<dowdata.data.length;i++){
								files.push(dowdata.data[i].fileName);
							}
						})
						if(files.length == 0){
						  return layer.msg('请选择文件!',{icon:0,time:1200});
						} 
						var comment = $('#comment').val();
						var result = 1;
						var name = "Download";
						var url = "/versions/"+flowNo+"/download"
					    var form = $("<form></form>").attr("action", url).attr("method", "get");
					    form.append($("<input></input>").attr("type", "hidden").attr("name", "files").attr("value", encodeURI(files)));
					    form.append($("<input></input>").attr("type", "hidden").attr("name", "comment").attr("value", comment));
					    form.append($("<input></input>").attr("type", "hidden").attr("name", "result").attr("value", result));
					    form.append($("<input></input>").attr("type", "hidden").attr("name", "name").attr("value", name));
					    form.append($("<input></input>").attr("type", "hidden").attr("name", "currenter").attr("value", currenter));
					    // form.append($("<input></input>").attr("type", "hidden").attr("name", "Authorization").attr("value","Bearer "+token));
					    form.appendTo('body').submit().remove();
					    form = '';
					    files = [];
					 }else{
						 return layer.msg('请重新登录！',{icon:0,time:1200});
					 }
				 }
			    ,error:function(){
			    	return layer.msg('系统出错了!');
			    }
			 })
				
			})
			
		$('#closeIframe').click(function(){
			parent.layer.closeAll();
		})
			
 
		function dateFormat(val) {
			if (val != null) {
				var val = val.toString();
				var date = new Date(parseInt(val.replace("/Date(", "").replace(
						")/", ""), 10));
				//月份为0-11所以+1，月份小于10补个0
				var month = date.getMonth() + 1 < 10 ? "0"
						+ (date.getMonth() + 1) : date.getMonth() + 1;
				var currentDate = date.getDate() < 10 ? "0" + date.getDate()
						: date.getDate();
				var hour = date.getHours() < 10 ? "0" + date.getHours() : date
						.getHours();
				var minute = date.getMinutes() < 10 ? "0" + date.getMinutes()
						: date.getMinutes();
				var second = date.getSeconds() < 10 ? "0" + date.getSeconds()
						: date.getSeconds();
				var dd = date.getFullYear() + "-" + month + "-" + currentDate
						+ " " + hour + ":" + minute + ":" + second;
				return dd;
			}
		}
	</script>

</body>
</html>