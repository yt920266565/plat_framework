<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<title>版本文件下载</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" type="text/css"
	href="/static/layui-v2.5.6/layui/css/layui.css">
<script type="text/javascript" src="/static/js/jquery-2.1.1.min.js"></script>
</head>
<body>

	<form class="layui-form" action="" style="margin-top: 20px">

		<div class="layui-form-item layui-form-text layui-hide">
			<label class="layui-form-label">填写人</label>
			<input class="layui-input" disabled id="operator" style="width:200px;display:inline;">
			<input class="layui-input" type="hidden" id="flowNo">
			<input class="layui-input" type="hidden" id="status">
		</div>
		
		<div class="layui-form-item layui-form-text">
			<label class="layui-form-label">废弃原因</label>
			<div class="layui-input-block">
				<textarea placeholder="请填写要废弃此版本的原因"
					class="layui-textarea" id="comment"></textarea>
			</div>
		</div>

	</form>

	<div class="layui-input-block">
			<button type="button" class="layui-btn" id="submit">提交</button>
			<button type="button" class="layui-btn layui-btn-primary " id="return">返回</button>
	</div>
	
	<script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
	<script>
		var storage = window.localStorage;
		var token = storage.getItem("token");
		function initData(data) {
			$('#flowNo').val(data.flowNo);
			$('#status').val(data.status);
			if(data.status == 10){
				$("div").removeClass('layui-hide');
				$.ajax({
					url:"/versions/discard/getDiscardOpt/"+data.flowNo,
					type:'get',
					beforeSend:function(request){
			 			request.setRequestHeader("Authorization","Bearer "+token);
			 	    },
					dataType:'json',
					success:function(res){
						if(res.status == 200){
							$("#operator").val(res.data.operator);
							$("#comment").val(res.data.comment);
						}
					}
				})
			}
		}
		
		 $('#submit').click(function() {
			 var comment = $('#comment').val();
			 var flowNo = $('#flowNo').val();
			 var status = $('#status').val();
			 if(comment == ''){
				 return layer.msg('请填写废弃原因!',{icon : 0});
			 }
			 var data = {"comment":comment,"mFlowNo":flowNo,"name":"Discard"}
			 if(status == 6){
				 $.ajax({
					 url:'/versions/discard',
					 type:'post',
					 data:JSON.stringify(data),
					 beforeSend:function(request){
				 			request.setRequestHeader("Authorization","Bearer "+token);
				 	 },
				 	 contentType:'application/json;charset=utf-8',
					 dataType:'json',
					 success:function(res){
						 if(res.status == 200){
							 parent.$('.layui-laypage-btn').click();
							 close();
							 return top.layer.msg('提交成功',{icon:1,time:1200})
						 }else if(res.status == 401){
							 return layer.msg('请重新登录!',{icon:0})
						 }else if(res.status == 403){
							 return layer.msg('你没有废弃权限!',{icon:0})
						 }else{
							 return layer.msg('提交失败，请重试!',{icon:0})
						 }
					 }
				    ,error:function(){
				    	return layer.msg('系统出错了!');
				    }
				 })
			 }else{
				 $.ajax({
					 url:'/versions/discard',
					 type:'put',
					 data:JSON.stringify(data),
					 beforeSend:function(request){
				 			request.setRequestHeader("Authorization","Bearer "+token);
				 	 },
				 	 contentType:'application/json;charset=utf-8',
					 dataType:'json',
					 success:function(res){
						 if(res.status == 200){
							 parent.$('.layui-laypage-btn').click();
							 close();
							 return top.layer.msg('提交成功',{icon:1,time:1200})
						 }else if(res.status == 401){
							 return layer.msg('请重新登录!',{icon:0})
						 }else if(res.status == 403){
							 return layer.msg('你没有修改权限!',{icon:0})
						 }else{
							 return layer.msg('提交失败，请重试!',{icon:0})
						 }
					 }
				    ,error:function(){
				    	return layer.msg('系统出错了!');
				    }
				 })
			 }
			 
			 
				
			})
			
			$('#return').click(function(){
				close();
			})
		
			//关闭所有弹出框
			function close(){
			  parent.layer.closeAll(); 
		    }
		 
		 layui.use('form',function(){
			 
		 })
 
	</script>
	<script>
		
	</script>

</body>
</html>