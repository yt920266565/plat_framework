<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>Layui</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" type="text/css" href="../../layui-v2.5.6/layui/css/layui.css">
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
  <script type="text/javascript" src="../../js/xm-select.js"></script>
</head>
<style type="text/css">
	.layui-textarea{
		width:81%;
	}
</style>
<body>
 
<form class="layui-form" action="" style="margin-top:20px">
  <div class="layui-form-item">
    <label class="layui-form-label">项目名称</label>
    <div class="layui-input-block">
      <input type="text" name="projName" id="projName" lay-verify="title" disabled autocomplete="off"  class="layui-input" style="width:81%">
      <!-- <input type="hidden"  id="cfgManager"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="testManager"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="applicant"   autocomplete="off"  class="layui-input" > -->
      <input type="hidden" name="testManager"    autocomplete="off"  class="layui-input" >
      <input type="hidden" name="flowNo" id="flowNo"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="createTime"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="applyTime"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="buildTime"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="testTime"   autocomplete="off"  class="layui-input" >
      <input type="hidden"  id="builder"   autocomplete="off"  class="layui-input" >
      <input type="hidden" " id="buildTime"   autocomplete="off"  class="layui-input" >
       <input type="hidden" " id="verInfo"   autocomplete="off"  class="layui-input" >
       <!-- <input type="hidden" " id="tempInfo"   autocomplete="off"  class="layui-input" > -->
    </div>
  </div>
  
   <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">产品线</label>
      <div class="layui-input-inline">
        <select  id="deptId"  disabled >
          <option value="">选择或搜索</option>
            <option value="134">产品一部</option>
          <option value="132">产品二部</option>
          <option value="133">产品三部</option>
          <option value="135">产品四部</option>
          <option value="162">产品五部</option>
          <option value="136">派科斯</option>
          <option value="155">软件部</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">客户名称</label>
      <div class="layui-input-inline">
        <select  id="client" disabled lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label" style="width:84px">被测产品大类</label>
      <div class="layui-input-inline">
        <select  id="product" disabled lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
   <div class="layui-inline">
      <label class="layui-form-label layui-required">料号</label>
      <div class="layui-input-inline">
        <input type="text" name="subPartNo" lay-verify="required" disabled id="subPartNo" autocomplete="off" class="layui-input">
      </div>
    </div>
  </div>
   <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">测试类型</label>
      <div class="layui-input-inline">
        <select  id="testType"  disabled lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">版本类型</label>
      <div class="layui-input-inline">
        <select  id="verType" disabled lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">正式版本</option>
          <option value="2">临时版本</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">版本层级</label>
      <div class="layui-input-inline">
        <select  id="verlevel" disabled lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">产品版本</option>
          <option value="2">上位机</option>
          <option value="3">下位机</option>
          <option value="4">模块</option>
        </select>
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label ">版本包属性</label>
      <div class="layui-input-inline">
        <select   id="pkgType" disabled lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">完整版本</option>
          <option value="2">补丁版本</option>
        </select>
      </div>
    </div>
  </div>
  
  
  <div class="layui-form-item">
    <div class="layui-inline">
      <label class="layui-form-label">软件名称</label>
      <div class="layui-input-inline">
        <input type="text" name="verId" id="verId" lay-verify="text" disabled autocomplete="off" class="layui-input">
      </div>
    </div>
    <div class="layui-inline">
      <label class="layui-form-label">版本号</label>
      <div class="layui-input-inline">
        <input type="text" name="verNo" id="verNo" lay-verify="text" disabled  autocomplete="off" class="layui-input">
      </div>
    </div>
     <div class="layui-inline" id="testP">
      <label class="layui-form-label layui-required" >测试人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" name="appManager" disabled id="tester" lay-search="">
          <option value="">选择或搜索</option>
        </select>
      </div>
    </div>
    <div class="layui-inline" id="testR">
      <label class="layui-form-label layui-required" >测试结论</label>
      <div class="layui-input-inline">
        <select  lay-verify="required"  disabled id="testResult" lay-search="">
          <option value="">选择或搜索</option>
          <option value="1">通过</option>
          <option value="2">不通过</option>
        </select>
      </div>
    </div>
  </div>
  <div id="verMainten" class="layui-form-item layui-hide">
   <div class="layui-inline ">
      <label class="layui-form-label layui-required" >版本申请人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required" disabled   id="applicant" lay-search="">
        </select>
      </div>
    </div>
       
  <div class="layui-inline" >
      <label class="layui-form-label layui-required" >配置管理员</label>
      <div class="layui-input-inline">
        <select  lay-verify="required"   id="cfgManager" lay-search="">
        </select>
      </div>
  </div>
  
   <div class="layui-inline" id="test">
      <label class="layui-form-label layui-required" >测试负责人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required"   id="testManager" lay-search="">
        </select>
      </div>
  </div>
  
   <div class="layui-inline" id="app">
      <label class="layui-form-label layui-required" >版本审批人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required"   id="appManager" lay-search="">
        </select>
      </div>
  </div>
  
  <div class="layui-inline" >
      <label class="layui-form-label layui-required" >版本发布人</label>
      <div class="layui-input-inline">
        <select  lay-verify="required"   id="publisher" lay-search="">
        </select>
      </div>
  </div>
 </div>
  <div class="layui-form-item layui-form-text">
      <label class="layui-form-label layui-required" >通知人员</label>
      <div style="width:76%;margin-left:109px" id="demoSale" ></div>
  </div>
  
    
  <div class="layui-form-item layui-form-text">
    <label class="layui-form-label">版本提取路径</label>
    <div class="layui-input-block">
        <input type="text"  id="verPath"  disabled placeholder="版本提取路径"  autocomplete="off" style="width:81%" class="layui-input">
      </div>
  </div>
  
  <div class="layui-form-item layui-form-text" id="build">
    <label class="layui-form-label">版本构建说明</label>
    <div class="layui-input-block">
        <textarea placeholder="应说明版本包由哪些部分组成，每一部分从哪里以何种方式获取" id="buildInfo"
					disabled class="layui-textarea"></textarea>
      </div>
  </div>
  
  <div class="layui-form-item layui-form-text" id="temp">
    <label class="layui-form-label">临时版本申请原因</label>
    <div class="layui-input-block">
        <input type="text"  id="tempInfo"  disabled placeholder="临时版本申请原因"  autocomplete="off" style="width:81%" class="layui-input">
      </div>
  </div>
  
  <div class="layui-form-item layui-form-text">
    <label class="layui-form-label">处理环节操作说明</label>
    <div class="layui-input-block">
      <textarea placeholder="文档齐套性检查;版本说明，测试报告，版本安装指导书文档是否齐全;国外客户是否支持英文" id="comment" class="layui-textarea" name="desc"></textarea>
    </div>
  </div>
  
  <div class="layui-form-item">
    <div class="layui-input-block">
      <button type="button" class="layui-btn layui-btn-normal" id="refPublish">拒绝发布</button>
      <button type="button"  class="layui-btn" id="agrPublish">同意发布</button>
    </div>
  </div>
</form>
<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<!-- 注意：如果你直接复制所有代码到本地，上述js路径需要改成你本地的 -->
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
var saleData = [];
function initSale(){
$.ajax({
	url:'/versions/getAllDistinctUR',
	type:'get',
	beforeSend:function(request){
		request.setRequestHeader("Authorization","Bearer "+token);
	},
	async:false,
	dataType:'json',
	success:function(res){
		for(var i=0; i<res.data.length; i++){ 
			var resdata = res.data[i];
		  if(resdata.roleid == 10 ){
			  saleData.push({"value":resdata.username,"userName":resdata.username,"name":resdata.realname+"("+resdata.username+")"})
		  }
    	}
	}
	});
}
initSale();
var demoSale = xmSelect.render({
	el:'#demoSale',
	language:'zn',
	data:saleData,
	filterable:true,
	toolbar:{show:true,list:["ALL","CLEAR"]}
});
$('#agrPublish').click(function(){
	var sendSale = demoSale.getValue('valueStr');
	if(sendSale == ''){
		return layer.msg('请选择要通知的人员!');
	}
	var flowNo = $('#flowNo').val();
	var data = redata('agr');
	$.ajax({
		url:'/versions/'+flowNo+'/'+sendSale+'/publish',
		type:'post',
		beforeSend:function(request){
			request.setRequestHeader("Authorization","Bearer "+token);
		},
		data:JSON.stringify(data),
		contentType:'application/json;charset=UTF-8',
		dataType:'json',
		async:false,
		success:function(res){
			if(res.status == 200){
				top.layer.msg('发布成功',{icon:1,time:800})
			 	window.parent.location.reload();
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			}else if(res.status == 403){
				top.layer.msg('没有版本发布权限!');
			}else if(res.status == 401){
				layer.msg('请重新登录!');
			}else{
				top.layer.msg('发布失败,可能是管理员更改了审批人，请刷新重试 !',{icon:0});
				window.parent.location.reload();
			}
			
		},
		error:function(){
			layer.msg('出错了');
		}
		
	});
})
$('#refPublish').click(function(){
	var flowNo = $('#flowNo').val();
	var data = redata('ref');
	$.ajax({
		url:'/versions/'+flowNo+'/publish',
		type:'post',
		beforeSend:function(request){
			request.setRequestHeader("Authorization","Bearer "+token);
		},
		data:JSON.stringify(data),
		contentType:'application/json;charset=UTF-8',
		dataType:'json',
		async:false,
		success:function(res){
			if(res.status == 200){
				top.layer.msg('拒绝成功',{icon:1,time:800})
			 	window.parent.location.reload();
				var index = parent.layer.getFrameIndex(window.name);
				parent.layer.close(index);
			}else if(res.status == 403){
				top.layer.msg('没有版本审批权限!');
			}else{
				top.layer.msg('拒绝失败');
			}
			
		},
		error:function(){
			layer.msg('出错了');
		}
		
	});
})
function redata(val){
	var projName = $('#projName').val();         
	var product = $('#product').val();         
	var subPartNo = $('#subPartNo').val();         
	var testType = $('#testType').val();         
	var verType = $('#verType').val();         
	var deptId = $('#deptId').val();         
	var client = $('#client').val();         
	var verlevel = $('#verlevel').val();         
	var pkgType = $('#pkgType').val();         
	var verId = $('#verId').val();         
	var verNo = $('#verNo').val();         
	var cfgManager = $('#cfgManager').val();         
	var testManager = $('input[name="testManager"]').val();;
	var publisher = $('#publisher').val();
	var verInfo = $('#verInfo').val(); 
	var createTime = $('#createTime').val();
	var applicant = $('#applicant').val();
	var applyTime = $('#applyTime').val();
	var builder = $('#builder').val();
	var buildTime = $('#buildTime').val();
	var testTime = $('#testTime').val();
	var tester = $('#tester').val();
	var testResult = $('#testResult').val();
	var comment = $('#comment').val();
	var verPath = $('#verPath').val();
	var buildInfo = $('#buildInfo').val();
	var tempInfo = $('#tempInfo').val();
	var infoPeople = demoSale.getValue('valueStr');
	var name = 'Publish';
	if(val == 'agr'){
		var status = 6;
		var result = 1;
	}else{
		var status = 102;
		var result = 0;
	}
	return data = {projName:projName,product:product,subPartNo:subPartNo,testType:testType,deptId:deptId,client:client,verType:verType,
		   		  verlevel:verlevel,pkgType:pkgType,verId:verId,verNo:verNo,testManager:testManager,cfgManager:cfgManager,
				  verInfo:verInfo,verPath:verPath,buildInfo:buildInfo,tempInfo:tempInfo,createTime:createTime,applicant:applicant,
			      applyTime:applyTime,builder:builder,buildTime:buildTime,testTime:testTime,tester:tester,testResult:testResult,
			      comment:comment,name:name,result:result,status:status,publisher:publisher,infoPeople:infoPeople};
}
function closeBtn(){
	var index = parent.layer.getFrameIndex(window.name);
	parent.layer.close(index);
}
function initData(data){
	layui.use('form',function(){
		var form = layui.form;
		var flowNo = data.flowNo;
		var projName = data.projName;
		var deptId = data.deptId;
		var client = data.client;
		var product = data.product;
		var subPartNo = data.subPartNo;
		var testType = data.testType;
		var verType = data.verType;
		var verlevel = data.verlevel;
		var pkgType = data.pkgType;
		var verNo = data.verNo;
		var verId = data.verId;
		var applicant = data.applicant;
		var cfgManager = data.cfgManager;
		var testManager = data.testManager;
		var publisher = data.publisher;
		var createTime = data.createTime;
		var applyTime =  data.applyTime;
		var builder = data.builder;
		var testTime =  data.testTime;
		var buildTime =  data.buildTime;
		var testResult = data.testResult;
		var verPath = data.verPath;
		var verInfo = data.verInfo;
		var buildInfo = data.buildInfo;
		var tempInfo = data.tempInfo;
		var tester = data.tester;
		$('input[name="testManager"]').val(testManager);
		if (verType == 1) {
			$('#temp').addClass("layui-hide");
			$('#buildInfo').val(buildInfo);
			$('#testResult').val(testResult);
			$("#testManager").append("<option value='"+testManager+"' selected ></option>");
			$("#cfgManager").append("<option value='"+cfgManager+"' selected ></option>"); 
			$("#applicant").append("<option value='"+applicant+"' selected ></option>");
			$("#publisher").append("<option value='"+publisher+"' selected ></option>");
		} else {
			$('#build').addClass("layui-hide");
			$('#tempInfo').val(tempInfo);
			$("#applicant").append("<option value='"+applicant+"' selected ></option>");
			$("#cfgManager").append("<option value='"+cfgManager+"' selected ></option>"); 
			$("#publisher").append("<option value='"+publisher+"' selected ></option>");
			$("#appManager").append("<option value='"+appManager+"' selected ></option>");
			$('#testP').addClass('layui-hide');
			$('#testR').addClass('layui-hide');
		}
		$.ajax({
			url:'/versions/users',
			type:'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			async:false,
			dataType:'json',
			success:function(res){
				for(var i=0; i<res.data.length; i++){ 
					if (tester ==res.data[i].id && verType == 1){
		    			$("#tester").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>"); 
		    		}else{
		    	       $("#tester").append("<option value='"+res.data[i].id+"'>"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}
		    	}
				form.render('select');
			}
		});
		$.ajax({
			url:'/versions/erpDict',
			type:'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			async:false,
			dataType:'json',
			success:function(res){
				var data = res.data;
				for(var i=0; i<data.length; i++){ 
					if(data[i].type == 'product'){
						if(data[i].code == product){
						  $("#product").append("<option value='"+product+"' selected>"+product+"</option>");
						}else{
		    	          $("#product").append("<option value='"+data[i].code+"'>"+data[i].code+"</option>"); 
						}
					}else if(data[i].type == 'test'){
						var test1 = data[i].code+" "+data[i].name
					  	if(test1 == testType.trim()){
					  		$("#testType").append("<option value='"+testType+"' selected>"+testType+"</option>");
					  	}else{
		    	           $("#testType").append("<option value='"+data[i].code+" "+data[i].name+"'>"+data[i].code+" "+data[i].name+"</option>");
					  	}
					}else{
						var client1 = data[i].code+" "+data[i].name
						if(client1 == client.trim()){
						  $("#client").append("<option value='"+client+"' selected>"+client+"</option>");
						}else{
		    	     	  $("#client").append("<option value='"+data[i].code+" "+data[i].name+"'>"+data[i].code+" "+data[i].name+"</option>"); 
						}
					}
		    	}
				form.render('select');
			}
		});
		
		$('#flowNo').val(flowNo);
		$('#projName').val(projName);
		$('#product').val(product);
		$('#deptId').val(deptId);
		$('#client').val(client);
		$('#subPartNo').val(subPartNo);
		$('#testType').val(testType);
		$('#verType').val(verType);
		$('#verlevel').val(verlevel);
		$('#pkgType').val(pkgType);
		$('#verNo').val(verNo);
		$('#verId').val(verId);
		/* $('#cfgManager').val(cfgManager);
		$('#testManager').val(testManager);
		$('#applicant').val(applicant); */
		$('#createTime').val(createTime);
		$('#applyTime').val(applyTime);
		$('#builder').val(builder);
		$('#buildTime').val(buildTime);
		$('#testTime').val(testTime);
		$('#tester').val(tester);
		$('#verPath').val(verPath);
		$('#verInfo').val(verInfo);
		$('#buildInfo').val(buildInfo);
		$('#tempInfo').val(tempInfo);
		form.render();
	});
}
//版本维护更新获取的数据
function getData(){
	var projName = $('#projName').val();         
	var product = $('#product').val();         
	var subPartNo = $('#subPartNo').val();         
	var testType = $('#testType').val();         
	var verType = $('#verType').val();         
	var deptId = $('#deptId').val();         
	var client = $('#client').val();   
	var verId = $('#verId').val();
	var verNo = $('#verNo').val();
	var verlevel = $('#verlevel').val();         
	var pkgType = $('#pkgType').val();         
	var cfgManager = $('#cfgManager').val();         
	var testManager = $('#testManager').val();
	var publisher = $('#publisher').val();
	var verInfo = $('#verInfo').val(); 
	var tester = $('#tester').val();
	var testResult = $('#testResult').val();
	var verPath = $('#verPath').val();
	var buildInfo = $('#buildInfo').val();
	var tempInfo = $('#tempInfo').val();
	var comment = $('#comment').val();
	var name = 'Maintainence';
	var result = 1;
	var status = 4;
	return data = {projName:projName,product:product,subPartNo:subPartNo,testType:testType,deptId:deptId,client:client,verType:verType,
	   		  verlevel:verlevel,pkgType:pkgType,testManager:testManager,cfgManager:cfgManager,verId:verId,verNo:verNo,
			  verInfo:verInfo,verPath:verPath,buildInfo:buildInfo,tempInfo:tempInfo,status:status,publisher:publisher,
		      tester:tester,testResult:testResult,
		      name:name,result:result,comment:comment};
}

//版本维护界面所用
function hidebtn(data){
	layui.use('form',function(){
		var form = layui.form;
		$('#agrPublish').hide();
		$('#refPublish').hide();
		$('#projName').removeAttr("disabled");
		$('#deptId').removeAttr("disabled");
		$('#client').removeAttr("disabled");
		$('#product').removeAttr("disabled");
		$('#subPartNo').removeAttr("disabled");
		$('#testType').removeAttr("disabled");
		$('#verlevel').removeAttr("disabled");
		$('#pkgType').removeAttr("disabled");
		$('#tester').removeAttr("disabled");
		$('#verPath').removeAttr("disabled");
		
		$('#verMainten').removeClass('layui-hide');
		var testManager = data.testManager;
		var cfgManager = data.cfgManager;
		var applicant = data.applicant;
		var publisher = data.publisher;
		var verType = data.verType;
		if(verType == 1){
			$('#app').addClass('layui-hide');
		}else{
			$('#test').addClass('layui-hide');
		}
		$.ajax({
			url:'/versions/getDistinctUR',
			type:'get',
			dataType:'json',
			success:function(res){
				for(var i=0;i<res.data.length;i++){
					if (applicant ==res.data[i].id ){
		    			$("#applicant").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}                                                 
					if (cfgManager ==res.data[i].id ){
		    			$("#cfgManager").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>"); 
		    		}else if(res.data[i].roleid.indexOf(2) != -1){
		    			$("#cfgManager").append("<option value='"+res.data[i].id+"'  >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}
					if (testManager ==res.data[i].id && verType == '1'){
		    			$("#testManager").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}else if(res.data[i].roleid.indexOf(3) != -1){
		    			$("#testManager").append("<option value='"+res.data[i].id+"'  >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}
					if (testManager ==res.data[i].id && verType == '2' ){
		    			$("#appManager").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>"); 
		    		}else if(res.data[i].roleid.indexOf(5) != -1){
		    			$("#appManager").append("<option value='"+res.data[i].id+"'  >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}
					if (publisher ==res.data[i].id ){
		    			$("#publisher").append("<option value='"+res.data[i].id+"' selected >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>"); 
		    		}else if(res.data[i].roleid.indexOf(4) != -1){
		    			$("#publisher").append("<option value='"+res.data[i].id+"'  >"+res.data[i].realname+"("+res.data[i].username+")"+"</option>");
		    		}
				}
		           form.render('select');
			}
		})
	});
}
layui.use(['form', 'layedit', 'laydate'], function(){
	  var form = layui.form
	  ,laydate = layui.laydate;
	  //日期
	  laydate.render({
	    elem: '#startTime'
	    	,type:'datetime'
	  });
	  laydate.render({
	    elem: '#endTime'
	    ,type:'datetime'
	  });
	  
	  //自定义验证规则
	  form.verify({  
		  path: [
		    /^\//
		    ,'请检查测试报告存放路径是否正确'
		  ]
	  });
	  
	  
	});
</script>

</body>
</html>