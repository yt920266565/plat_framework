<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>关联用户</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../layui-v2.5.6/layui/css/layui.css"  media="all">
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
  <link rel="stylesheet" type="text/css" href="../../h-ui/h-ui/css/H-ui.min.css">
<link rel="stylesheet" href="../../h-ui/h-ui/css/iconfont.css" media="all"/>
<script src="/static/js/common.js" charset="utf-8"></script>
  <!-- ztree -->
	<link href="../../ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
	<script src="../../ztree/js/jquery.ztree.all.js"></script>
</head>
<body>
<div class="layui-btn-group demoTable" style="margin:15px 0px 5px">
  <button class="layui-btn " data-type="batdel" id="batdel">批量删除权限</button>
</div>

<div class="r" id="item-qry" style="margin-right:68%;margin-top:18px">
	<input type="text"  data-type="reload" id="staff" placeholder="请输入工号/姓名" autocomplete="off" style="width:180px;" class="input-text radius">
    <button id="btnSearch" data-type="reload" class="btn btn-primary radius"><i class="Hui-iconfont">&#xe665;</i></button>
</div>
<div style='height: 100%;border: 1px solid gray;width: 100%;'>
    <!-- <div id="op1">
         <button class="layui-btn layui-btn-xs" style="position:absolute;z-index: 10;height: 4%;padding: 0 0px; width: 14;"onClick="myop()"><i class="layui-icon">&#xe65b;</i></button>
    </div> -->
	<div class="easyui-resizable " id="tree" style='min-height:420px;width:18%;height:100%;border: 1px solid gray;float:left;'>
	     <div>
	         <button class="layui-btn layui-btn-fluid" onClick=""><i class="layui-icon">&#xe65a;</i> 
             </button>
         </div>
	     <ul id="strtree" class="ztree"></ul>
	</div>
	<div  style='height: 100%;width: 100%;margin-top:-19px;min-height:420px;'> 
		<table class="layui-table"  lay-filter="demo" id="testReload">	   
		</table>
    </div>
</div>

<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
 <script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs ModifyButPower"  lay-event="edit">修改</a>
  <a class="layui-btn layui-btn-xs layui-btn-danger"  lay-event="del">删除权限</a>
</script> 
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
init();
function init(){
	var setting = {
			 data: {
		            simpleData: {
		                enable: true,
		                idKey : "id",
		                pIdKey : "pid", 
		               },
		             key : {
		            	 name : "name"
		                 },
		             keep : {
		                    parent : true,//没有子节点也保持父节点状态
		                    leaf : false
		               }
		        },
	        callback: {
	    		onClick: zTreeOnClick
	    	}
	    };
	  var strdata = [];
	  $.ajax({
		  url:'/departments/getURDepartments',
		  type:'get',
		  dataTyoe:'json',
		  async:false,
		  success:function(res){
			  if(res.status == 200){
				  for(var i=0;i<res.data.length;i++){
					  strdata.push({"id":res.data[i].id,"name":res.data[i].name,"pid":res.data[i].pid});
				  }
			  }
		  },
		  error:function(){
			  layer.msg("功能权限获取失败");
		  }
		  
	  });
	  $.fn.zTree.init($("#strtree"), setting, strdata);
	 // expand();
  layui.use('table', function(){
	  var table = layui.table;
	  table.render({
		    elem: '#testReload'
		    ,url:'/departments/getURByDeptId'
	    	,parseData:function(res){ 
	        	return parseData(res); //common.js里面
	        }
		    ,headers:{Authorization:"Bearer "+token}
		    ,cols: [[
		       {type:'checkbox',style:'background:#e2e2e2',title:'全选'}
		      ,{field: '',width:'10%', align:'center', toolbar: '#barDemo',title:'操作'}
		      ,{field:'username',title:'工号',align:'center',width:'8%'}
		      ,{field:'realname',title:'姓名',align:'center',width:'8%'}
		      ,{field:'deptName',title:'部门',align:'center',width:'13%'}
		      ,{field:'rolename',title:'角色',align:'center',width:'26%'}
		      ,{field:'email',title:'企业邮箱',align:'center',width:'14%'}
		    ]]
		    ,page: true
		    ,id:'testReload'
		 });
	  table.on('tool(demo)',function(obj){
		  var data = obj.data;
		  if(obj.event == 'edit'){
			  layer.open({
				  type:2,
				  title:'用户所有角色信息',
				  shadeClose: true,
			      shade: 0.8,
			      scrollbar: false,
			      resize:false,
			      area: ['80%', '80%'],
		  	      content: '/static/templates/sec_manage/edit_user.html',
		  	      success:function(layero,index){
		  	    	var iframeWin = window['layui-layer-iframe' + index];
		            iframeWin.initData(data);//调用修改窗口的初始化方法
		  	      },
		  	      btn:['保存','取消'],
		  	      btn1:function(index, layero){
		  	    	var body = layer.getChildFrame('body', index);
	                var iframeWin = window[layero.find('iframe')[0]['name']]; 
	                var datas = iframeWin.getData();
	                var roles = datas.roles;
	                if(roles == '' || roles == undefined){
	                	return layer.msg('请给用户选择分配的角色',{icon:0,time:1500});
	                }
	                $.ajax({
	                	url:'/users',
	                	type:'put',
	                	beforeSend:function(request){
	        				request.setRequestHeader("Authorization","Bearer "+token);
	        			},
	                	data:JSON.stringify(datas),
	                	contentType:'application/json;charset=UTF-8',
	                	dataType:'json',
	                	success:function(res){
	                		if(res.status == 200){
	                			top.layer.msg('更新成功',{icon:1,time:1000});
	                			window.location.reload();
	                			var index = parent.layer.getFrameIndex(window.name);
						        parent.layer.close(index);
	                		}else if(res.status == 403){
	                			layer.msg('没有权限',{icon:0,time:1000});
	                			iframeWin.refresh();
	                		}else{
	                			layer.msg('更新失败',{icon:0,time:1000});
	                			iframeWin.refresh();
	                		}
	                	},
	                	error:function(){
	                		layer.msg('出错了',{time:1000});
	                		iframeWin.refresh();
	                	}
	                })
	                
		  	      }
			  });
		  }else if(obj.event == 'del'){
			  layer.confirm('确定删除此用户所有权限吗？', function(index){
		  		  var id =data.id;
		  		  $.ajax({
		  			  url:'/users/'+id,
		  			  type:'delete',
		  			  beforeSend:function(request){
	    				 request.setRequestHeader("Authorization","Bearer "+token);
	    			  },
		  			  dataType:'json',
		  			  success:function(res){
		  				  if(res.status == 200){
		  					  layer.msg('删除成功',{icon:1,time:800});
		  					 $(".layui-laypage-btn").click();
		  				  }else{
		  					layer.msg('删除失败',{icon:1,time:800});
		  				  }
		  			  },
		  			  error:function(){
		  				  layer.msg('出错了!',{time:1000})
		  			  }
		  		  })
		      });
		  }
	  })
  });
}

  //设置节点展开
  function expand(){
	  var treeObj = $.fn.zTree.getZTreeObj("strtree");
	  var nodes = treeObj.getNodes();
	  for (var i = 0; i < nodes.length; i++) { //设置节点展开
        treeObj.expandNode(nodes[i], true, false, true);
	    /* var nodespan = nodes[i].children;
		for(var j = 0; j < nodespan.length; j++) { //设置节点展开第三级节点
			treeObj.expandNode(nodespan[j], true, false, true);
		} */
      } 
  }
  //ztree点击的回调函数
  function zTreeOnClick(){
		zTreeOnClicks();
 }
  //搜索按钮
  /* $('#btnSearch').click(function(){
	  zTreeOnClicks();
  }) */
  
  layui.use('table', function(){
	  var table = layui.table;
	  var $ = layui.$, active = {
	     deptReloads: function(){
	    	var zTree = $.fn.zTree.getZTreeObj("strtree");
			var nodes = zTree.getSelectedNodes();
			var treeNode = nodes[0];
			var deptId = treeNode.id;
			var nodedata = {deptId:deptId,"staff":''};
	       //执行重载
	       table.reload('testReload', {
	         page: {
	           curr: 1 //重新从第 1 页开始
	         }
	         ,where: nodedata
	       });
	     },reload:function(){
	    	 var staff = $('#staff').val();
	    	 var searchdata = {staff:staff,"deptId":''};
	    	//执行重载
		       table.reload('testReload', {
		         page: {
		           curr: 1 //重新从第 1 页开始
		         }
		         ,where: searchdata
		       });
	     }
	    
	  };
	  window.zTreeOnClicks = function(){
		  var type = "deptReloads";
		  active[type] ? active[type].call(this) : '';
	  }
	  $('#btnSearch').on('click', function(){
 	    var type = $(this).data('type');
	    active[type] ? active[type].call(this) : '';
	  });
	  
});
</script>
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
var deldata = [];
$('#batdel').click(function(){
	getData();
	if(deldata == ''|| deldata.length == 0){
	  return layer.msg('请选择用户!',{icon:0,time:1000});
	}
	var data = {"userid":deldata}
	$.ajax({
		url:"/users/batDelUser",
		type:'delete',
		data:JSON.stringify(data),
		beforeSend:function(request){    
		  request.setRequestHeader("Authorization","Bearer "+token);
		},
		contentType:'application/json;charset=UTF-8',
		dataType:'json',
		success:function(res){
			if(res.status == 200){
				top.layer.msg('删除成功',{icon:1,time:1000});
				deldata = [];
				$(".layui-laypage-btn").click();
			}else if(res.status == 403){
				top.layer.msg('没有权限',{icon:0,time:1000});
				deldata = [];
			}else{
				top.layer.msg('提交失败',{icon:0,time:1000});
				deldata = [];
			}
		},
		error:function(){
			top.layer.msg('出错了!',{time:1000});
			deldata = [];
		}
		
	})
	
})
function getData(){
	layui.use('table', function(){
		  var table = layui.table;
	  /* table.on('checkbox(demo)',function(obj){
		  var data = obj.data; */
		  var checkStatus=table.checkStatus('testReload'),
          data=checkStatus.data;
		  for(var i=0;i<data.length;i++){
			  deldata.push(data[i].id)
		  }
	});
}
	
	$('#staff').keyup(function(event){
		if(event.keyCode == 13){
			  $('#btnSearch').click();
		}
	})
	
  
  </script>

</body>
</html>