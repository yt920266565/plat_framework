<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>角色管理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../layui-v2.5.6/layui/css/layui.css"  media="all">
  <link rel="stylesheet" href="../../h-ui/h-ui/css/iconfont.css" media="all"/>
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
  <script src="/static/js/common.js" charset="utf-8"></script>
  <!-- ztree -->
	<link href="../../ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
	<link rel="stylesheet" type="text/css" href="../../h-ui/h-ui/css/H-ui.min.css">
	<script src="../../ztree/js/jquery.ztree.all.js"></script>
	<style>
		.layui-table, .layui-table-view {
			margin: 5px 0;
		}
    </style>
</head>
<body>
	 <div style="margin-top:50px;">
	 	 <button type="submit" class="layui-btn" id="addrole">新增角色</button>
	 	 <input type="text" id="name" placeholder="角色名" autocomplete="off" style="width:180px;margin-left:100px;" class="input-text radius">
    	<button id="btnSearch"  class="btn btn-primary radius"><i class="Hui-iconfont">&#xe665;</i></button>
	 </div>
	 <table id="roleManage" class="layui-table" lay-filter="demo"></table>
<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs layui-btn-danger" lay-event="delete">删除</a>
  <a class="layui-btn layui-btn-xs layui-btn" lay-event="edit">权限维护</a>
  <a class="layui-btn layui-btn-xs layui-btn" lay-event="relate">人员维护</a>
</script>        
 
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
$('#addrole').click(function(){
	layer.open({
	  type:2,
	  title:'添加角色',
      shadeClose: true,
	  shade: 0.8,
	  scrollbar: false,
      resize:false,
	  area: ['90%', '90%'],
	  content: "/static/templates/sec_manage/addrole.html",
	  success:function(layero,index){
	  }
	})
})
layui.use('table', function(){
  var table = layui.table;
  table.render({
    elem: '#roleManage'
    ,url:'/roles/list'
   	,parseData:function(res){ 
       	return parseData(res); //common.js里面
     }
    ,headers:{Authorization:"Bearer "+token}
    ,page:true
    ,cols: [[
      {field: '',fixed: true,width:'15%', align:'center', toolbar: '#barDemo',title:'操作'}
      ,{field:'name', align:'center',title: '角色名'}
      ,{field:'users',width:'20%',align:'center', title: '用户组'}
      ,{field:'func',width:'20%',align:'center', title: '拥有的功能权限'}
      ,{field:'datas',width:'20%',align:'center', title: '拥有的数据权限'}
      ,{field:'description',align:'center', title: '描述'}
    ]]
  });
  
  $('#btnSearch').click(function(){
	  var name = $('#name').val();
	  table.reload('roleManage', {
	     page: {
	        curr: 1 //重新从第 1 页开始
	     }
	      ,where: {
	    	  name : name
	      }
	  });
  })
  
  $('#name').keyup(function(event){
	  if(event.keyCode == 13){
		  $('#btnSearch').click();
	  }
  })
  
  table.on('tool(demo)',function(obj){
	  var data = obj.data;
	  if(obj.event == 'edit'){
		  layer.open({
			  type:2,
			  title:'更新角色信息',
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['98%', '98%'],
	  	      content: '/static/templates/sec_manage/update_role.html',
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data);//调用修改窗口的初始化方法
	  	      }
		  });
	  }else if(obj.event == 'relate'){
		  layer.open({
			  type:2,
			  title:'关联用户',
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['98%', '98%'],
	  	      content: "/static/templates/sec_manage/relate_user.html",
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data);//调用修改窗口的初始化方法
	  	      }
		  });
	  }else if(obj.event == 'delete'){
		  layer.confirm('确定删除吗？', function(index){
	  		  var id =data.id;
	  		  if(id == -1){
	  			  return layer.msg('该角色需要联系IT人员才能删除!',{icon:0,time:1500});
	  		  }
	  		  
	  		  $.ajax({
	  			  url:'/roles/'+id,
	  			  type:'delete',
	  			  beforeSend:function(request){
    				 request.setRequestHeader("Authorization","Bearer "+token);
    			  },
	  			  dataType:'json',
	  			  success:function(res){
	  				  if(res.status == 200){
	  					  layer.msg('删除成功',{icon:1,time:800});
	  					 // window.location.reload();
	  					$(".layui-laypage-btn").click();
	  				  }else{
	  					layer.msg('删除失败',{icon:0,time:800});
	  				  }
	  			  },
	  			  error:function(){
	  				  layer.msg('出错了!',{time:1000})
	  			  }
	  		  })
	      });
	  }
  })
	  
});
</script>

</body>
</html>