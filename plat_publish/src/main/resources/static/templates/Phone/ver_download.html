<!DOCTYPE html>
<html lang="zh-cn">
<head>
<meta charset="utf-8">
<title>版本文件下载</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
<link rel="stylesheet" type="text/css"
	href="../../layui-v2.5.6/layui/css/layui.css">
<script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
<script src="/static/js/common.js" charset="utf-8"></script>
</head>
<body>

	<table class="layui-table" lay-filter="check" id="test">
	</table>
	<div class="layui-input-block">
			<button type="submit" class="layui-btn" id="download">下载</button>
	</div>
	<div style="color:red;margin-top:20px;text-align:center;">PS:请点击右上角选择用浏览器打开此页面进行下载</div>
	<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn layui-btn" lay-event="deal">下载</a>
</script>
	<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
	<script>
		var flowNo = '';
		var files = [];
		/* function initData(data) {
			flowNo = data.flowNo;
			layui.use('table', function() {
				var table = layui.table;
				table.render({
					id : 'test',
					elem : '#test',
					url : '/versions/' + flowNo + '/files',
					cols : [ [ {
						field : '',
						fixed : true,
						align : 'center',
						type : 'checkbox',
						style : 'background:#efe1e1;'
					}, {
						field : 'fileName',
						title : '文件名'
					}, {
						field : '',
						title : '大小',
						templet : function(d) {
							if(d.size>1024){
								return Math.round(d.size/1024) + " M"
							}
							return d.size + " kb";
						}
					}, {
						field : 'editTime',
						title : '修改日期',
						templet : function(d) {
							return dateFormat(d.editTime);
						}
					} ] ]
				});
			});
		} */
		if(flowNo == ''){
			init();
		}
		function init() {
			var url = window.location.search;
    		if(url.indexOf("flowNo") != -1){
    			console.log("2222222");
    			var str = url.substr(1);
    			strs = str.split("=");
    			flowNo = strs[1];
    			console.log(flowNo);
    		}
			layui.use('table', function() {
				var table = layui.table;
				table.render({
					id : 'test',
					elem : '#test',
					url : '/versions/' + flowNo + '/files',
					parseData:function(res){ 
			        	return parseData(res); //common.js里面
			        },
					cols : [ [ {
						field : '',
						fixed : true,
						align : 'center',
						type : 'checkbox',
						style : 'background:#efe1e1;'
					}, {
						field : 'fileName',
						title : '文件名'
					}, {
						field : '',
						title : '大小',
						templet : function(d) {
							if(d.size>1024){
								return Math.round(d.size/1024) + " M"
							}
							return d.size + " kb";
						}
					}, {
						field : 'editTime',
						title : '修改日期',
						templet : function(d) {
							return dateFormat(d.editTime);
						}
					} ] ]
				});
			});
		}
		 $('#download').click(function() {
				layui.use('table',function(){
					var table = layui.table;
					var dowdata = table.checkStatus('test');
					for(var i = 0;i<dowdata.data.length;i++){
						files.push(dowdata.data[i].fileName);
					}
				})
				if(files.length == 0){
				  return layer.msg('请选择文件!',{icon:0,time:1200});
				} 
				var url = "/phone/"+flowNo+"/download"
			    var form = $("<form></form>").attr("action", url).attr("method", "get");
			    form.append($("<input></input>").attr("type", "hidden").attr("name", "files").attr("value", encodeURI(files)));
			    form.appendTo('body').submit().remove();
			    form = '';
			    files = [];
			 });
 
		function dateFormat(val) {
			if (val != null) {
				var val = val.toString();
				var date = new Date(parseInt(val.replace("/Date(", "").replace(
						")/", ""), 10));
				//月份为0-11所以+1，月份小于10补个0
				var month = date.getMonth() + 1 < 10 ? "0"
						+ (date.getMonth() + 1) : date.getMonth() + 1;
				var currentDate = date.getDate() < 10 ? "0" + date.getDate()
						: date.getDate();
				var hour = date.getHours() < 10 ? "0" + date.getHours() : date
						.getHours();
				var minute = date.getMinutes() < 10 ? "0" + date.getMinutes()
						: date.getMinutes();
				var second = date.getSeconds() < 10 ? "0" + date.getSeconds()
						: date.getSeconds();
				var dd = date.getFullYear() + "-" + month + "-" + currentDate
						+ " " + hour + ":" + minute + ":" + second;
				return dd;
			}
		}
	</script>
	<script>
		
	</script>

</body>
</html>