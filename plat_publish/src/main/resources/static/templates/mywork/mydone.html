<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>我处理的</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../layui-v2.5.6/layui/css/layui.css"  media="all">
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
  <script src="/static/js/common.js" charset="utf-8"></script>
  <style type="text/css">
  .layui-form-item .layui-inline {
    margin-bottom: 0px;
    margin-right: 5px;
}
.layui-table, .layui-table-view {
     margin: 0 0; 
}
.layui-form-item {
    margin-bottom: 8px;
}
  </style>
</head>
<body>
<form class="layui-form" id="formEnter" action="" style="margin-top:20px">
   <div class="layui-form-item">
   
    <label class="layui-form-label">版本流水号:</label>
    <div class="layui-input-inline">
      <input type="text" id="mFlowNo" lay-verify="title" autocomplete="off"  class="layui-input" >
    </div>
    
    <label class="layui-form-label">处理环节:</label>
    <div class="layui-input-inline">
		<select id="dealProcess" lay-filter="dealProcess"  lay-verify="required"
			id="verType" lay-search="">
			<option value="">选择或搜索</option>
			<option value="Apply">版本申请</option>
			<option value="Build">版本构建</option>
			<option value="Test">版本测试</option>
			<option value="Approve">版本审批</option>
			<!-- <option value="Publish">版本发布</option> -->
			<option value="Download">文件下载</option>
			<option value="Rollback">版本回滚</option>
			<option value="Maintainence">版本维护</option>
			<option value="Stop">流程终止</option>
			<option value="Discard">废弃版本</option>
		</select>
	</div>
	
    <label class="layui-form-label">申请人:</label>
    <div class="layui-input-inline">
		<select id="operator" lay-filter="operator"  lay-verify="required" lay-search="">
		  <option value="">选择或搜索</option>
		</select>
	</div>
	
  </div>
  <div class="layui-form-item">
    <label class="layui-form-label">关键字:</label>
    <div class="layui-input-inline">
      <input type="text" id="keyWord" style="width: 220px;" lay-verify="title" placeholder="项目名称或版本描述里的关键字" autocomplete="off"  class="layui-input">
    </div>
    <label class="layui-form-label">软件名称:</label>
    <div class="layui-input-inline">
      <input type="text" id="verId" lay-verify="title" autocomplete="off"  class="layui-input" >
    </div>
    <label class="layui-form-label">版本号:</label>
    <div class="layui-input-inline">
      <input type="text" id="verNo" lay-verify="title" autocomplete="off"  class="layui-input">
    </div>
  </div>
</form>
 <div class="layui-input-block">
      <button type="button" class="layui-btn layui-btn-sm layui-btn-normal" id="reset">重置</button>
      <button type="button" class="layui-btn layui-btn-sm" style="margin-left:96px"  data-type="reload" id="search">查询</button>
 </div>
	<table class="layui-table" id="mydone" lay-filter='demo'></table>
              
<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script type="text/html" id="barDemo">
  <a class="layui-btn-primary layui-btn-xs " id="deal" lay-event="detail">详情</a>
  {{#  if(d.name == 'Apply' && (d.status == 2 || d.status == 5)){ }}
    <a class="layui-btn layui-btn-xs " id="deal" lay-event="edit">编辑</a>
  {{#  } }}
  {{#  if(d.name == 'Apply'){ }}
    <a class="layui-btn layui-btn-normal layui-btn-xs" id="apply" lay-event="apply">申请</a>
  {{#  } }}
</script> 

<script>

var storage=window.localStorage;
var token = storage.getItem("token");
$.ajax({
	url:'/versions/mydone/getApplyGrpAll',
	type:'get',
	beforeSend:function(request){
		request.setRequestHeader("Authorization","Bearer "+token);
	},
	async:false,
	dataType:'json',
	success:function(res){
		for(var i=0; i<res.data.length; i++){ 
			var resdata = res.data[i];
			$('#operator').append('<option value='+resdata.username+'>'+resdata.realname+"-"+resdata.username+'</option>')
    	}
	}
	});
layui.use(['table','form'], function(){
  var table = layui.table,form = layui.form;
  table.render({
    elem: '#mydone'
    ,headers:{Authorization:"Bearer "+token}
    ,url:'/versions/mydone'
   	,parseData:function(res){ 
       	return parseData(res); //common.js里面
     }
    ,cols: [[
       {field: '',fixed: true,width:'150', align:'center', toolbar: '#barDemo',title:'操作'}
       ,{field:'projName',width:'350', title: '项目名称'}
	   ,{field:'deptId',width:'100', title: '产品线',templet:function(d){
    	  if(d.deptId == 134){
    		  return '产品一部'
    	  }else if(d.deptId == 132){
    		  return '产品二部'
    	  }else if(d.deptId == 133){
    		  return '产品三部'
    	  }else if(d.deptId == 135){
    		  return '产品四部'
    	  }else if(d.deptId == 162){
    		  return '产品五部'
    	  }else if(d.deptId == 136){
    		  return '派科斯'
    	  }else if(d.deptId == 155){
    		  return '软件部'
    	  }else{
    		  return '产品线'
    	  }
	      }}
	  ,{field:'client',width:'131', title: '客户名称'}
	  ,{field:'verId',width:'234',  title: '软件名称'}
	  ,{field:'verNo',width:'102',  title: '版本号'}
      ,{field:'name',width:'102', title: '处理环节',templet:function(d){
    	  if(d.name == "Apply"){
    		  return "申请";
    	  }else if(d.name == "Build"){
    		  return "构建";
    	  }else if(d.name == "Test"){
    		  return "测试";
    	  }else if(d.name == "Publish"){
    		  return "发布";
    	  }else if(d.name == "Approve"){
    		  return "审批";
    	  }else if(d.name == "Maintainence"){
    		  return "维护";
    	  }else if(d.name == "Rollback"){
    		  return "回退";
    	  }else if(d.name == "Stop"){
    		  return "终止流程";
    	  }else if(d.name == "Download"){
    		  return "下载";
    	  }else if(d.name == "Discard"){
    		  return "废弃";
    	  }else if(d.name == "Recover"){
    		  return "恢复";
    	  }else{
    		  return "default";
    	  }
    	  
      }}
      ,{field:'result',width:'102', title: '处理结果',templet:function(d){
    	  if(d.name == 'Test' &&　d.result == 1){
    		  return "通过";
    	  }else if(d.name == 'Test' &&　d.result == 0){
    		  return "不通过";
    	  }else if(d.name == 'Approve' &&　d.result == 1){
    		  return "通过";
    	  }else if(d.name == 'Approve' &&　d.result == 0){
    		  return "不通过";
    	  }else if(d.name == 'Publish' &&　d.result == 1){
    		  return "通过";
    	  }else if(d.name == 'Publish' &&　d.result == 0){
    		  return "不通过";
    	  }else{
    		  return "成功";
    	  }
      }}
      ,{field:'testResult',width:'129', title: '测试结果',templet:function(d){
    	  if(d.testResult == 1){
    		  return "测试通过";
    	  }else if(d.testResult == 2 ){
    		  return "测试不通过";
    	  }else if(d.status == 100){
    		  return "流程被终止";
    	  }else if(d.verType == 2){
    		  return "临时版本无需测试";
    	  }else {
    		  return "还未测试";
    	  }
      }}
      ,{field:'',width:'165',sort:true, title: '处理时间',templet:function(d){
    	  return dateFormat(d.optime);
      }}
      ,{field:'comment',width:'187',  title: '处理说明'}
      ,{field:'mFlowNo',width:'165',  title: '版本流水号'}
    ]]
    ,id:'test'
    ,page: true
  });
  
  table.on('tool(demo)',function(obj){
	  var data = obj.data;
	  var flowNo = data.flowNo;
	  var content ='';
	  var title = '';
	  if(obj.event == 'detail'){
		  var status = data.status;
		  var content = '/static/templates/mywork/mydone_process.html';
		  if(status == 1){  //待申请
			//  content = '/static/templates/ver_manage/ver_apply_edit.html';
			//title = '版本待申请';
		  }else if(status == 2){ //待构建
			//  content = '/static/templates/ver_manage/ver_build.html'
			//title = '版本待构建';
		  }else if(status == 3){ //待测试
			//  content = '/static/templates/ver_manage/published_detail.html'
		    //title = '版本待测试';
		  }else if(status == 4){  //待发布
			//  content = '/static/templates/ver_manage/ver_publish.html'
			//title = '版本待发布';
		  }else if(status == 5){  //待审批
			//  content = '/static/templates/ver_manage/ver_approval.html'
			//title = '版本待审批';
		  }else if(status == 100){
			  //title = '版本流程被终止';
		  }else if(status == 101){
			//title = '审批拒绝';
		  }else if(status == 102){
			//title = '发布拒绝';
		  }
		  layer.open({
			  type:2,
			  title:title,
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['90%', '90%'],
	  	      content: content,
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data,'');//调用修改窗口的初始化方法
	          //  iframeWin.hidebtn();
	  	      }
		  });
	  }else if(obj.event == 'edit'){
		  layer.open({
			  type:2,
			  title:'修改我申请的版本基本信息',
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['90%', '90%'],
		      btn:['更新','取消'],
	  	      content: '/static/templates/mywork/mydone_edit.html',
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data);//调用修改窗口的初始化方法
	  	      },
	  	    btn1:function(index,layero){
		    	var body = layer.getChildFrame('body', index);
	            var iframeWin = window[layero.find('iframe')[0]['name']]; 
	            var datas = iframeWin.getData();
	            datas.flowNo = flowNo;
	            var projName = datas.projName;
	            var deptId = datas.deptId;
	            var product = datas.product;
	            var subPartNo = datas.subPartNo;
	            var testType = datas.testType;
	            var verlevel = datas.verlevel;
	            var verType = datas.verType;
	            var pkgType = datas.pkgType;
	            var verInfo = datas.verInfo;
	            var buildInfo = datas.buildInfo;
	            if( verInfo == ''){
	            	return layer.msg('版本描述不能为空',{time:1000});
	            }
	            if(projName == '' ){
	            	return layer.msg('项目名不能为空',{time:1000});
	            }
	            if(deptId == '' ){
	            	return layer.msg('产品线不能为空',{time:1000});
	            }
	            if(subPartNo == '' ){
	            	return layer.msg('子料号序号不能为空',{time:1000});
	            }
	            if(product == '' ){
	            	return layer.msg('被测产品大类不能为空',{time:1000});
	            }
	            if(testType == '' ){
	            	return layer.msg('测试类型不能为空',{time:1000});
	            }
	            if(verlevel == '' ){
	            	return layer.msg('版本层级不能为空',{time:1000});
	            }
	            if(pkgType == '' ){
	            	return layer.msg('版本包属性不能为空',{time:1000});
	            }
	            if(buildInfo == '' && verType == 1){
	            	return layer.msg('构建说明不能为空',{time:1000});
	            }
	         	$.ajax({
	         		url:'/versions/mydone/update',
	         		type:'put',
	         		beforeSend:function(request){
	        			request.setRequestHeader("Authorization","Bearer "+token);
	        		},
	         		data:JSON.stringify(datas),
	         		contentType:'application/json;charset=UTF-8',
	         		dataType:'json',
	         		success:function(res){
	         			if(res.status == 200){
	         				layer.msg('更新成功',{icon:1,time:1000});
	         				layer.closeAll('iframe');
	        				$(".layui-laypage-btn").click();
	         			}else if(res.status == 403){
	         				top.layer.msg('没有更新权限!',{icon:0})
	         			}else if(res.status == 401){
	         				top.layer.msg('请重新登录!',{icon:0})
	         			}else if(res.status ==  409){
	         				top.layer.msg('该软件名称和版本已存在，请勿重复修改',{icon:0})
	         			}
	         		},
	         		error:function(){
	         			top.layer.msg('出错了!');
	         		}
	         	});
		     }
		  });
		  
	  }else if(obj.event == 'apply'){
		  layer.open({
			  type:2,
			  title:'快捷申请',
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['90%', '90%'],
	  	      content: '/static/templates/mywork/mydone_edit.html',
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data);//调用修改窗口的初始化方法
	            iframeWin.quickApply(data);//调用修改窗口的初始化方法
	  	      }
		  })
	  }
  })

  
var $ = layui.$, active = {
	    reload: function(){
	      var data = '';
	      var mFlowNo = $('#mFlowNo').val().trim();
	      var keyWord = $('#keyWord').val().trim();
	      var verId = $('#verId').val().toString();
	      var verNo = $('#verNo').val().toString();
	      var operator = $('#operator').val().toString();
	      var dealProcess = $('#dealProcess').val().toString();
	      if(operator == ''){
	    	  data={ mFlowNo:mFlowNo,verId:verId,verNo:verNo, keyWord:keyWord,process:dealProcess}
	      }else{
	    	  data={ mFlowNo:mFlowNo,verId:verId,verNo:verNo, keyWord:keyWord,
		            operator : operator,process:dealProcess}
	      }
	      //执行重载
	       table.reload('test', {
	         page: {
	           curr: 1 //重新从第 1 页开始
	         }
	         ,where: data
	       });
	  }
	}
     $('#search').on('click', function(){
		  var type = $(this).data('type');
		  active[type] ? active[type].call(this) : ''; 
	}); 
   //监听整个表单的输入框
	$('#formEnter').keyup(function(event){
		if(event.keyCode == 13){
		  $('#search').click();
		}
	})
	
	form.on('select(dealProcess)',function(){
		active['reload'].call('reload');
	})
	
	form.on('select(operator)',function(){
		active['reload'].call('reload');
	})
	
	$('#reset').click(function(){
		  $('#mFlowNo').val('');
		  $('#verId').val('');
		  $('#verNo').val('');
		  $('#dealProcess').val('');
		  form.render('select');
	});
	
  
});
function dateFormat(val) {
    if (val != null) {
    	var val = val.toString();
        var date = new Date(parseInt(val.replace("/Date(", "").replace(")/", ""), 10));
        //月份为0-11所以+1，月份小于10补个0
        var month = date.getMonth() + 1 < 10 ? "0" + (date.getMonth() + 1) : date.getMonth() + 1;
        var currentDate = date.getDate() < 10 ? "0" + date.getDate() : date.getDate();
        var hour = date.getHours() < 10 ? "0" + date.getHours() : date.getHours();
        var minute = date.getMinutes() < 10 ? "0" + date.getMinutes() : date.getMinutes();
        var second = date.getSeconds() < 10 ? "0" + date.getSeconds() : date.getSeconds();
        var dd = date.getFullYear() + "-" + month + "-" + currentDate + " " + hour + ":" + minute + ":" + second;
        return dd;
    }
}
</script>

</body>
</html>