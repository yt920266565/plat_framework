<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>更新我的分组</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../../layui-v2.5.6/layui/css/layui.css"  media="all">
  <script type="text/javascript" src="../../../js/jquery-2.1.1.min.js"></script>
  <script src="../../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
  <script type="text/javascript" src="../../../js/xm-select.js"></script>
  <!-- ztree -->
	<link href="../../../ztree/css/zTreeStyle/zTreeStyle.css" rel="stylesheet" />
	<script src="../../../ztree/js/jquery.ztree.all.js"></script>
</head>
<body>
    <form class="layui-form" style="margin-top: 20px;"> 
	   <div class="layui-form-item">
			<div class="layui-inline">
				<label class="layui-form-label layui-required">组名:</label>
				<div class="layui-input-inline">
					<input type="text"  lay-verify="required" id="groupName" autocomplete="off" class="layui-input">
				</div>
			</div>
		</div>

		<div class="layui-form-item">
			<div class="layui-form-item layui-form-text">
				<label class="layui-form-label">组成员:</label>
				<div style="width: 73%; margin-left: 109px" id="demoSale"></div>
			</div>
		</div>
		
	</form>
		<div style="margin-left:150px;">
		    <button type="button" lay-submit=""  class="layui-btn" id="submit">提交</button>
		    <button type="button"   class="layui-btn layui-btn-primary" id="close" >返回</button>
		</div>
		
 
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
function initData(data){
	var groupId = data.groupId,groupName = data.groupName;
	var grpData = [],inData = data.staffCode;
	$('#groupName').val(groupName);
	if(inData != '' && inData != undefined){
		inData = inData.split(",");
	}
    //获取售后人员
	$.ajax({
		url:'/versions/getAllDistinctUR',
		type:'get',
		beforeSend:function(request){
			request.setRequestHeader("Authorization","Bearer "+token);
		},
		async:false,
		dataType:'json',
		success:function(res){
			for(var i=0; i<res.data.length; i++){ 
				var resdata = res.data[i];
			grpData.push({"value":resdata.username,"name":resdata.realname+"("+resdata.username+")"})
	    	}
		}
   });
	//多选下拉款渲染
	var demoSale = xmSelect.render({
		el:'#demoSale',
		language:'zn',
		autoRow: true,
		initValue:inData,
		data:grpData,
		filterable:true,
		toolbar:{show:true,list:["ALL","CLEAR"]}
	});
	
	$('#submit').click(function(){
	   var value = demoSale.getValue('value');
	   var list = [],groupName = $('#groupName').val();
	   if(groupName == ''){
		   return layer.msg('组名不能为空',{icon:0});
	   }
	   for(var i=0;i<value.length;i++){
		   list.push({"staffCode":value[i]});
	   }
	   var data = {"groupId":groupId,"list":list,"groupName":groupName}
	   $.ajax({
			url:'/myGroup/update',
			type:'put',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			contentType:'application/json;charset=utf-8',
			data:JSON.stringify(data),
			dataType:'json',
			success:function(res){
				if(res.msg == 'success'){
					parent.$('.layui-laypage-btn').click();
					close();
					return top.layer.msg('更新成功',{icon:1,time:1000})
				}else{
					return layer.msg('组的名字不允许重复',{icon:0,time:1500});
				}
			}
			,error:function(){
				return layer.msg('系统出错了',{icon:0,time:1500});
			}
		}) 
	})
}

function close(){
	parent.layer.closeAll();
}
	
	layui.use('form',function(){
		
	})
	
	function submit(){
		var groupName = $('#groupName').val();
		if(groupName == ""){
			return layer.msg('请输入组名',{icon:0});
		}
		var value = demoSale.getValue('value');
		var list = [];
		for(var i=0;i<value.length;i++){
			list.push({"staffCode":value[i]});
		}
		var data = {"groupName":groupName,"list":list};
		$.ajax({
			url:'/myGroup/insertUser',
			type:'post',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			contentType:"application/json;charset=utf-8",
			data:JSON.stringify(data),
			dataType:'json',
			success:function(res){
				if(res.msg == "success"){
					$('#groupName').val('');
					demoSale.setValue([]);
					parent.$('.layui-laypage-btn').click();
					return layer.msg('添加成功',{icon:1,time:1000});
				}else{
					return layer.msg('请检查组名字是否重复!',{icon:0})
				}
			}
			,error:function(){
				return layer.msg('系统错误,请联系IT',{icon:0});
			}
		})
	}
	
	
	$('#close').click(function(){
		parent.layer.closeAll('iframe');
	})
	
	
	  
</script>

</body>
</html>