<!DOCTYPE html>
<html lang="zh-cn">
<head>
  <meta charset="utf-8">
  <title>待我处理</title>
  <meta name="renderer" content="webkit">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" href="../../layui-v2.5.6/layui/css/layui.css"  media="all">
  <script type="text/javascript" src="../../js/jquery-2.1.1.min.js"></script>
  <script src="/static/js/common.js" charset="utf-8"></script>
</head>
<body>
           
<table class="layui-table" lay-filter="demo" id="mydo"></table>
              
<script src="../../layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script type="text/html" id="barDemo">
  <a class="layui-btn layui-btn-xs ModifyButPower" id="deal" lay-event="deal">处理</a>
</script> 
       
<script type="text/html" id="status">
  {{#  if(d.status == 1){ }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background: #5a98de;border-radius: 7px;">待申请</div>
  {{#  } else if(d.status == 2) { }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background:#3b373e;border-radius: 7px;">待构建</div>
  {{#  } else if(d.status == 3) { }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background:#3b373e ;border-radius: 7px;">待测试</div>
 {{#  } else if(d.status == 4) { }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background:#009688;border-radius: 7px;">待发布</div>
 {{#  } else if(d.status == 5) { }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background:#943e0c ;border-radius: 7px;">待审批</div>
  {{#  } else { }}
    <div style="color: white;width:82px;line-height:25px;text-align:center;background: #f37b1d;border-radius: 7px;">测试中</div>
{{#  } }}
</script> 
       
 
<script>
var storage=window.localStorage;
var token = storage.getItem("token");
layui.use('table', function(){
  var table = layui.table;
  
  table.render({
    elem: '#mydo'
    ,url:'/versions/mydo'
   	,parseData:function(res){ 
       	return parseData(res); //common.js里面
     }
    ,headers:{Authorization:"Bearer "+token}
    ,cols: [[
      {field: '',fixed: true, align:'center', toolbar: '#barDemo',title:'操作'}
      ,{field:'status',width:'10%', align:'center',title: '状态',templet:'#status'}
      ,{field:'currName', title: '当前处理人'}
      ,{field:'projName', title: '项目名称'}
      ,{field:'deptId', title: '产品线',templet:function(d){
    	  if(d.deptId == 134){
    		  return '产品一部'
    	  }else if(d.deptId == 132){
    		  return '产品二部'
    	  }else if(d.deptId == 133){
    		  return '产品三部'
    	  }else if(d.deptId == 135){
    		  return '产品四部'
    	  }else if(d.deptId == 162){
    		  return '产品五部'
    	  }else if(d.deptId == 136){
    		  return '派克斯'
    	  }else if(d.deptId == 155){
    		  return '软件部'
    	  }else{
    		  return '产品线'
    	  }
      }}
      ,{field:'client', title: '客户名称'}
      ,{field:'verId', title: '软件名称'}
      ,{field:'verNo', title: '版本号'}
      ,{field:'verlevel', title: '版本范围',templet:function(d){
    	  if(d.verlevel == 1){
    		  return '产品';
    	  }else if(d.verlevel == 2){
    		  return '上位机';
    	  }else if(d.verlevel == 3){
    		  return '下位机';
    	  }else if(d.verlevel == 4){
    		  return '模块';
    	  }
      }}
      ,{field:'verType', title: '版本类型',templet:function(d){
    	  if(d.verType == 1){
    		  return '正式版本';
    	  }else if(d.verType == 2){
    		  return '临时版本';
    	  }
      }}
      ,{field:'subPartNo', title: '料号'}
      ,{field:'flowNo',width:'10%', title: '版本流水号'}
    ]]
    ,page: true
    ,id:'test'
  });
  
  table.on('tool(demo)',function(obj){
	  var data = obj.data;
	  var content ='';
	  var title = '';
	  if(obj.event == 'deal'){
		  var status = data.status;
		  if(status == 1){  //待申请
			//  content = '/static/templates/ver_manage/ver_apply_edit.html';
			//  title = '版本待申请';
		  }else if(status == 2){ //待构建
			//  content = '/static/templates/ver_manage/ver_build.html'
			//  title = '版本待构建';
		  }else if(status == 3){ //待测试
			//  content = '/static/templates/ver_manage/ver_test.html'
			//	  title = '版本待测试';
		  }else if(status == 4){  //待发布
			 // content = '/static/templates/ver_manage/ver_publish.html'
			//	  title = '版本待发布';
		  }else if(status == 5){  //待审批
			//  content = '/static/templates/ver_manage/ver_approval.html'
			//	  title = '版本待审批';
		  }else{}
		  layer.open({
			  type:2,
			  title:title,
			  shadeClose: true,
		      shade: 0.8,
		      scrollbar: false,
		      resize:false,
		      area: ['90%', '90%'],
	  	      content: '/static/templates/mywork/mydone_process.html',
	  	      success:function(layero,index){
	  	    	var iframeWin = window['layui-layer-iframe' + index];
	            iframeWin.initData(data,'mydo');//调用修改窗口的初始化方法
	            //测试阶段点击处理按钮就将状态改为处理中
	            if(status == 3){
	            	$.ajax({
	            		url:'/versions/mydo/changeTestStatus/'+data.flowNo,
	            		beforeSend:function(request){
	        				request.setRequestHeader("Authorization","Bearer "+token);
	        			},
	            		type:'put',
	            		async:false,
	            		dataType:'json',
	            	})
	            }
	  	      },
	  	      end:function(){
 	             $('.layui-laypage-btn').click();
	  	      }
		  
		  });
	  }
  })

var $ = layui.$, active = {
	    reload: function(){
	      var demoReload = $('#mydo');
	      
	      //执行重载
	      table.reload('mydo', {
	        page: {
	          curr: 1 //重新从第 1 页开始
	        }
	        ,where: {
	          key: {
	            id: demoReload.val()
	          }
	        }
	      }, 'data');
	    }
	  };
	  
	  $('.demoTable .layui-btn').on('click', function(){
	    var type = $(this).data('type');
	    active[type] ? active[type].call(this) : '';
	  });
});
</script>

</body>
</html>