<html>
<head>
<meta charset="utf-8">
<title>良率分析报表</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
  <link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui/css/H-ui.min.css">
  <link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui.admin/css/H-ui.admin.css" />
  <link rel="stylesheet" href="/static/h-ui/h-ui/css/iconfont.css" media="all"/>
  <link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css"  media="all">
  <link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">
  
  <script src="/static/js/jquery.min.js" charset="utf-8"></script>
  <script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
  <script src="/static/js/echarts/echarts.min.js" charset="utf-8"></script>
  <script src="/static/js/ehartsStyle.js" charset="utf-8"></script>
  <script src="/static/templates/common.js" charset="utf-8"></script>

</head>
<body>
    <div class="layui-tab">
		<ul class="layui-tab-title">
			<li class="layui-this">良率分析报表</li>
			<li>图表</li>
		</ul>

		<div class="layui-tab-content">
			<div class="layui-tab-item layui-show">
				<div class="layui-row" style="margin-left:10px;">
					<div class="layui-col-mid2 layui-col-lg2">
						<label>机台:</label> <input id="machineId" class="layui-input">
					</div>
					<div class="layui-col-mid2 layui-col-lg2">
						<label>料号:</label> <input id="partName" class="layui-input">
					</div>
					<div class="layui-col-mid2 layui-col-lg2">
						<label>日期:</label> <input id="fcyDate" class="layui-input">
					</div>
					<div class="layui-col-mid5 layui-col-lg6">
						<label>客户区域:</label>
						<form class="layui-form" id="fcySelect" style="display: inline-block;width:30%">
							<select class="layui-form" id="workArea" lay-filter="workArea"
								lay-verify="" lay-search>
							</select>
						</form>
						<label>车间:</label>
						<form class="layui-form"  id="fcySelect" style="display: inline-block;width:30%">
							<select class="layui-form" id="workshop" lay-filter="workshop"
								lay-verify="" lay-search>
								<option value="">请选择或搜索</option>
							</select>
						</form>
						<button id="btnSearch" data-type="reload"
							class="btn btn-primary radius">
							<i class="Hui-iconfont">&#xe665;</i>
						</button>
						<button class="btn btn-primary radius " value="导出Excel" style="margin-left: 10px;"
							onclick="dbtnExcel()">导出Excel</button>
					</div>
					<table class="layui-table" lay-filter="demo" id="testReload">
					</table>
				</div>
			</div>

			<div class="layui-tab-item">
			<div id="main" style="width: 1500px;height:600px;"></div>
			   <!--  <div id="main" style="width: 600px;height:400px;"></div> -->
			</div>
		</div>
	</div>
    
<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token");
	layui.use(['element','table','laydate','upload','form'], function() {
		var element = layui.element,laydate = layui.laydate,upload = layui.upload,
	    form = layui.form,table = layui.table,$ = layui.$;
		
		//初始化车间
		initWorkshop();
		
		var html = [],dutyData = [];
		html[0] = [];
		html[0][0] = {field:'machineId', title:'机台名称',align:'center',minWidth:213};
    	html[0][1] = {field:'workshop', title:'车间',align:'center',width:87};
		html[0][2] = {field:'productType', title:'产品类型',align:'center',minWidth:90};
		html[0][3] = {field:'partName', title:'料号',align:'center', minWidth:90};

		//根据日期，加载日期列
		function getDutyDate(html){
			var data = getSearchParamData();
			for(var i=4;i<html[0].length;i++){
				if(html[0][i] != ''){
					html[0][i] = '';
				}
			}
			$.ajax({
				url:'/duty/title',
				type:'get',
				beforeSend:function(request){
					request.setRequestHeader("Authorization","Bearer "+token);
				},
				data:data,
				dataType:'json',
				async:false,
				success:function(res){
					var count = 0;
					for(var i=0;i<res.length;i++){
						html[0][i+4] = {field:res[i], title:res[i],align:'center',minWidth:80}
						dutyData.push(res[i]);
					}
				}
			})
		}
		getDutyDate(html);
		
		//列值改变重新渲染
		function tableRender(html){
			var data = getSearchParamData();
			table.render({
				elem: '#testReload'
			    ,url:'/duty/report'
			    ,headers:{Authorization:"Bearer "+token}
				,parseData:function(res){ 
			       	return parseData(res); //common.js里面
			     }
			    ,limit:30
			    ,where:data
			    ,cols:html
			    ,page: true
			    ,id:'testReload'
			});
		}
		tableRender(html);
		
		function charts(){
			var data = [],machineData = [];
			var paramData = getSearchParamData();
			$.ajax({
				url:'/duty/report?page=1&limit=5',
				type:'get',
				data: paramData,
				beforeSend:function(request){
					request.setRequestHeader("Authorization","Bearer "+token);
				},
				dataType:'json',
				success:function(res){
					if(res.status == 403){
						return layer.msg('没有权限!');
					}
					for(var i=0;i<res.data.length;i++){
						var temp = [];
						for(var j=0;j<dutyData.length;j++){
							var temp1 = res.data[i];
							var temp2 = dutyData[j];
							temp.push(temp1[temp2].replace('%',""));
							if(j < dutyData.length-1){
								continue;
							}
					        data.push({"name":res.data[i].machineId,"type":"line","data":temp});
					        machineData.push(res.data[i].machineId);
						}
					}
					// 基于准备好的dom，初始化echarts实例
				    var myChart = echarts.init(document.getElementById('main'),'roma');
				    myChart.clear(this.option);
				    // 指定图表的配置项和数据
				     var option = {
				        title: {
				            text: '良率分析报表'
				        },
				        tooltip: {},
				        legend: {
				            data : machineData,
				            left : '100px'
				        },
				        xAxis: {
				        	type:'category',
				            data: dutyData
				        },
				        yAxis: {
				        	type:'value',
							interval: 50, //间隔
							minInterval: 1, //设置成1保证坐标轴分割刻度显示成整数。
				        },
				        series: data,
				        label: {
				            show: true
				          }
				    }; 
				    
				    myChart.setOption(option);
				}
			})
		}
		charts();
		
		//表格重载
		var $ = layui.$, active = {
			reload:function(){
			  getDutyDate(html);
			  tableRender(html);
			  charts();
		    }
		}
		
		//获取查询参数
		function getSearchParamData(){
			var paramData,startDate = '',endDate = '',machineId = $('#machineId').val();
			var workArea = $('#workArea').val(),fcyDate = $('#fcyDate').val(),partName = $('#partName').val(); 
			var workshop = $('#workshop').val();
			if(fcyDate != ''){
				startDate = fcyDate.split("~")[0].trim();
				endDate = fcyDate.split("~")[1].trim();
				paramData = {"workArea":workArea,"startDate":startDate,workshop:workshop,
				          "endDate":endDate,"partName":partName,"machineId":machineId};
			}else{
				paramData = {"workshop":workshop,"workArea":workArea,"partName":partName,"machineId":machineId};
			}
			return paramData;
		}
		
		form.on('select(workArea)',function(){
			initWorkshop();
			var type = "reload";
			active[type] ? active[type].call(this) : '';
		})
		
		form.on('select(workshop)',function(){
			var type = "reload";
			active[type] ? active[type].call(this) : '';
		})
		 
		 $('#partName').bind('keyup',function(event){
			 if(event.keyCode == '13'){
				 active['reload'].call(this);
			 }
		 })
		 $('#machineId').bind('keyup',function(event){
			 if(event.keyCode == '13'){
				 active['reload'].call(this);
			 }
		 })
		 $('#btnSearch').on('click', function(){
		    var type = $(this).data('type');
		    active[type] ? active[type].call(this) : '';
		 });

    var startTime = getDay(-7);
    var endTime = getDay(-1);
    
    laydate.render({
	   elem: '#fcyDate' //指定元素
	   ,type:'date'
	   ,range: '~'
 	   ,value: startTime + ' ~ ' + endTime
	});

});

	
//导出数据
function dbtnExcel(){
	var partName = $('#partName').val(); 
	var fcyDate = $('#fcyDate').val(); 
	var workshop = $('#workshop').val(); 
	var workArea = $('#workArea').val(),startDate,endDate;  
	if(fcyDate != ''){
		startDate = fcyDate.split("~")[0].trim();
		endDate = fcyDate.split("~")[1].trim();
	    window.location.href = '/fcy/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&startDate='+startDate+'&endDate='+endDate+'&limit=99990&page=1'
	    return;
	 }
	window.location.href = '/fcy/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&limit=99990&page=1'
}

	
</script>
</body>
</html>
