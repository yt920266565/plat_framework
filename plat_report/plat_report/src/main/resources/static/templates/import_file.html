<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>导入数据</title>
  <link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css"  media="all">
  <link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
  <script src="/static/js/jquery.min.js" charset="utf-8"></script>
  <script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
  <script src="/static/templates/common.js" charset="utf-8"></script>
</head>
<style type="text/css">
.layui-input, .layui-textarea {
    width: 76%;
    padding-left: 10px;
}
.layui-table td, .layui-table th {
    padding: 9px 10px;
}
</style>
<!-- style="overflow-x:hidden;overflow-y:hidden" -->
<body>
<div style="border-right: 1px solid black;width:859px;display:inline-block;">
  <form class="layui-form" style="margin-top: 10px;" action="">
  
  <div class="layui-form-item">
    <label class="layui-form-label">开始时间</label>
    <div class="layui-input-inline">
      <input id="startDate" class="layui-input">
    </div>
    
    <label class="layui-form-label">结束时间</label>
    <div class="layui-input-inline">
      <input id="endDate" class="layui-input">
    </div>
  </div>
  
  <div class="layui-form-item">
    <label class="layui-form-label">数据来源文件路径</label>
    <div class="layui-input-inline">
    <input id="filePath" type="text" class="layui-input" style="width: 600px;">
    </div>
    
  </div>
  
  <div class="layui-form-item">
    <label class="layui-form-label">报表类型</label>
    <div class="layui-input-block">
      <input type="checkbox" class="children" name="byDay" id="byDay"  checked title="按天导入">
      <input type="checkbox" class="children" name="byDuty" id="byDuty"  checked  title="按班次导入">
      <input type="checkbox" class="children" name="byHour"  id="byHour"  checked title="按小时导入">
      <input type="checkbox" class="children" name="update" id="update"  checked title="更新已存在数据">
	  <button class="layui-btn layui-btn-normal layui-btn-lg" type="button" onclick="importFile()">导入</button>
    </div>
    
  </div>
  
</form>
</div>

<div style="display: inline-block;width: 400px;margin-left: 50px;">
  <button class="layui-btn layui-btn-lg" id="uploadList" type="button">选择文件(只支持zip压缩包)</button>
  
  <div class="layui-upload-list">
    <table class="layui-table">
      <thead>
        <tr><th>文件名</th>
        <th>大小</th>
        <th>状态</th>
        <th>操作</th>
      </tr></thead>
      <tbody id="demoList"></tbody>
    </table>
  </div>
  <button class="layui-btn layui-btn-normal layui-btn-lg layui-hide" type="button" id="uploadFile">根据绑定的"uploadFile"触发上传</button>
  <button class="layui-btn layui-btn-normal layui-btn-lg" type="button"  onclick="uploadFile()">上传文件</button>
	
</div >


	<fieldset class="layui-elem-field layui-field-title"
		style="margin-top: 30px;">
		<legend>导入数据日志</legend>
	</fieldset>
	<table class="layui-table" lay-filter="logTable" id="logTable">
	 
	 </table>



</body>

<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token"); //localStorage存储的token
var fileCount = 0,fileName = ''//上传的文件数量,文件名
    layui.use(['form','laydate','table','upload'],function(){
    	var form = layui.form,laydate = layui.laydate,$ = layui.$,table = layui.table,upload = layui.upload;
    	var startTime = getDay(-1);
    	
		table.render({
				elem : '#logTable',
				url : '/import/allLog',
				limit : 10,
				headers:{Authorization:"Bearer "+token},
				parseData:function(res){ 
			       	return parseData(res); //common.js里面
			    },
				cols : [[
				     {field:'',align:'center',title: '导入时间',templet:function(d){
				    	 return dateFormat(d.createtime);
				     }}
				    ,{field:'count', title: '导入条数'}
				    ,{field:'username', title: '导入人员'}
				    ,{field:'', title: '导入方式',templet:function(d){
				    	if(d.auto == false){
				    		return '人员手动';
				    	}
				    	return '系统自动';
				    }}
				]],
				page:true,
				id : 'logTable'
			});

		//初始化数据源文件路径
		$.ajax({
			url : '/config/path',
			type : 'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			success : function(res) {
				$('#filePath').val(res);
			},
			error : function(res) {
				return layer.msg('获取数据源文件路径失败!', {
					icon : 0
				});
			}
		})
		
		//多文件列表示	
		var show = '';
		var demoListView = $('#demoList')
		,uploadListIns = upload.render({
		  elem: '#uploadList'
		  ,url: '/importFile/upload' 
		  ,accept: 'file'
		  ,auto: false
		  ,size: 1024*10
		  ,bindAction: '#uploadFile'
		  ,before:function(obj){
			  show = showUploadLoad();
		  }
		  ,choose: function(obj){   
		    var files = this.files = obj.pushFile(); //将每次选择的文件追加到文件队列
		    //读取本地文件
		    obj.preview(function(index, file, result){
		      var tr = $(['<tr id="upload-'+ index +'">'
		        ,'<td>'+ file.name +'</td>'
		        ,'<td>'+ (file.size/1024).toFixed(1) +'kb</td>'
		        ,'<td>等待上传</td>'
		        ,'<td>'
		          ,'<button class="layui-btn layui-btn-xs demo-reload layui-hide">重传</button>'
		          ,'<button class="layui-btn layui-btn-xs layui-btn-danger demo-delete">删除</button>'
		        ,'</td>'
		      ,'</tr>'].join(''));
		      //上传的文件名
		      fileName = file.name;
		      //单个重传
		      tr.find('.demo-reload').on('click', function(){
		        obj.upload(index, file);
		      });
		      
		      //删除
		      tr.find('.demo-delete').on('click', function(){
		        delete files[index]; //删除对应的文件
		        tr.remove();
		        uploadListIns.config.elem.next()[0].value = ''; //清空 input file 值，以免删除后出现同名文件不可选
		        if(--fileCount == 0){
		        	fileName = '';
		        };
		      });
		      
		      demoListView.append(tr);
		      fileCount++;
		    });
		  }
		  ,done: function(res, index, upload){
		    if(res.status == 200){ //上传成功
		      layer.close(show);
		      layer.msg('上传成功',{icon:1});
		      var tr = demoListView.find('tr#upload-'+ index)
		      ,tds = tr.children();
		      tds.eq(2).html('<span style="color: #5FB878;">上传成功</span>');
		      tds.eq(3).html(''); //清空操作
		      delete this.files[index]; //删除文件队列已经上传成功的文件
		      return $('.layui-laypage-btn').click();
		    }
		    this.error(index, upload);
		  }
		  ,error: function(index, upload){
		    var tr = demoListView.find('tr#upload-'+ index)
		    ,tds = tr.children();
		    tds.eq(2).html('<span style="color: #FF5722;">上传失败</span>');
		    tds.eq(3).find('.demo-reload').removeClass('layui-hide'); //显示重传
		    layer.msg('上传失败',{icon:0});
		  }
		});
		
		laydate.render({
			elem : '#startDate',
			type : 'date',
			value : getDay(-1)
		})

		laydate.render({
			elem : '#endDate',
			type : 'date',
			value : new Date()
		})

	})
	
	function uploadFile(){
		if(fileName == ''){
			return layer.msg('请选择要上传的zip文件!');
		}
		if(fileCount> 1){
			return layer.msg('只能上传单个文件!');
		}
		if(!fileName.endsWith('.zip')){
			return layer.msg('只能上传zip文件!');
		}
		$("#uploadFile").click();
	}

	function importFile() {
		var folderPath = $('#filePath').val();
		if (folderPath == '') {
			layer.msg('请输入要导入文件的路径!', {
				icon : 0
			});
			return;
		}

		var startDate = $('#startDate').val();
		var endDate = $('#endDate').val();
		var byDay = $("#byDay").is(":checked");
		var byDuty = $("#byDuty").is(":checked");
		var byHour = $("#byHour").is(":checked");
		var update = $("#update").is(":checked");
		var importData = {
			folderPath : folderPath,
			startDate : startDate,
			endDate : endDate,
			update : update,
			byDay : byDay,
			byDuty : byDuty,
			byHour : byHour
		}

		if (!byDay && !byDuty && !byHour) {
			return layer.msg('请选择要导入的报表类型!', {
				icon : 0
			});
		}
		$.ajax({
			url : '/file/folder',
			type : 'post',
			beforeSend : function(request) {
				showLoad();
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			data : JSON.stringify(importData),
			contentType : 'application/json;charset=utf-8',
			dataType : 'json',
			success : function(res) {
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
				if (res.status == 200) {
					window.location.reload();
					return top.layer.msg('导入成功', {
						icon : 1
					});
				}
				return layer.msg('导入失败,错误原因' + res.data, {
					icon : 0
				});
			},
			error : function(res) {
				if (res.status == 200) {
					return layer.msg('导入成功', {
						icon : 1
					});
				}
				return layer.msg('导入失败,错误原因' + res.data, {
					icon : 0
				});
			}
		})
	}

	function showLoad() {
		return layer.msg('正在导入,请稍等...', {
			icon : 16,
			shade : [ 0.5, '#f5f5f5' ],
			scrollbar : false,
			offset : 'auto',
			time : 6000000
		});
	}
	
	function showUploadLoad() {
		return layer.msg('正在上传,请稍等...', {
			icon : 16,
			shade : [ 0.5, '#f5f5f5' ],
			scrollbar : false,
			offset : 'auto',
			time : 6000000
		});
	}

	function getDay(day) {
		var today = new Date();
		var targetday_milliseconds = today.getTime() + 1000 * 60 * 60 * 24
				* day;
		today.setTime(targetday_milliseconds); //注意，这行是关键代码
		var tYear = today.getFullYear();
		var tMonth = today.getMonth();
		var tDate = today.getDate();
		tMonth = doHandleMonth(tMonth + 1);
		tDate = doHandleMonth(tDate);
		return tYear + "-" + tMonth + "-" + tDate;
	}

	function doHandleMonth(month) {
		var m = month;
		if (month.toString().length == 1) {
			m = "0" + month;
		}
		return m;
	}
</script>

</html>