<html>
<head>
<meta charset="utf-8">
<title>告警分析报表</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui/css/H-ui.min.css">
<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" href="/static/h-ui/h-ui/css/iconfont.css" media="all"/>
<link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css"  media="all">
<link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">

<script src="/static/js/jquery.min.js" charset="utf-8"></script>
<script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script src="/static/js/echarts/echarts.min.js" charset="utf-8"></script>
<script src="/static/js/ehartsStyle.js" charset="utf-8"></script>
<script src="/static/templates/common.js" charset="utf-8"></script>
<style type="text/css">
</style>
</head>
<body>

<div class="layui-tab">
	<ul class="layui-tab-title">
		<li class="layui-this">告警分析报表</li>
		<li>告警分析图表</li>
	</ul>
	
	<div class="layui-tab-content" style="overflow-x:hidden;overflow-y:hidden;">
	  <div class="layui-tab-item layui-show">
	    <div class="layui-row" style="margin-left: 10px;">
	    
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>机台:</label>
	        <input id="machineId" class="layui-input">
	     </div>
	     
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>料号:</label>
	        <input id="partName" class="layui-input">
	     </div>
	     
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>日期:</label>
	        <input id="alarmDate" class="layui-input">
	     </div>
	     
	     <div class="layui-col-mid5 layui-col-lg6">
				<label>客户区域:</label>
				<form class="layui-form"  style="display: inline-block; width:30%">
					<select class="layui-form" id="workArea" lay-filter="workArea"
						lay-verify="" lay-search>
					</select>
				</form>
				
				<label>车间:</label>
				<form class="layui-form" i style="display: inline-block; width:30%">
					<select class="layui-form" id="workshop" lay-filter="workshop"
						lay-verify="" lay-search>
						<option value="">选择或搜索</option>
					</select>
				</form>
				<button id="btnSearch" data-type="reload" class="btn btn-primary radius">
	            <i class="Hui-iconfont">&#xe665;</i>
	        </button>
	        <button  class="btn btn-primary radius " style="margin-left:10px;"
	        value="导出Excel" onclick="dbtnExcel()">导出Excel</button>
	     </div>
	       <table class="layui-table" lay-filter="demo" id="testReload">
		</table>
	   </div>
	  </div>
	  
	   <div class="layui-tab-item">
	      <div class="layui-row" style="margin-left: 10px;">
	      		 <div  class="layui-col-mid1 layui-col-lg1">
		   	       <form class="layui-form">
		        	<input type="checkbox"  name="multipart" id="multipart" lay-filter="multipart" checked title="多机台">
		          </form>
		        </div>
		     
		   	  <div id="partNameDiv" class="layui-col-mid2 layui-col-lg2">
		        <label>料号:</label>
		        <input id="barPartName" class="layui-input">
		     </div>
		     
		   	  <div id="machineDiv" class="layui-col-mid2 layui-col-lg2 layui-hide">
		        <label>机台:</label>
		        <input id="pieMachineId" class="layui-input">
		     </div>
		     
		     <div id="pieDateDiv" class="layui-hide">
			     <div class="layui-col-mid3 layui-col-lg3">
			        <label>开始日期:</label>
			        <input id="alarmStartDate" class="layui-input">
			     </div>
			     
			     <div class="layui-col-mid3 layui-col-lg3">
			        <label>结束日期:</label>
			        <input id="alarmEndDate" class="layui-input">
			     </div>
			 </div>
			 
			  <div id="barDateDiv" class="layui-col-mid2 layui-col-lg2">
		        <label>日期:</label>
		        <input id="barDate" class="layui-input">
		      </div>
		     
		     <div class="layui-col-mid2 layui-col-lg1">
		     	<button id="pieSearch"  class="btn btn-primary radius">
			            <i class="Hui-iconfont">&#xe665;</i>
				</button>
		     </div>
		     
		  </div>
		  
	      <div id="pieCharts" style = "padding-top:20px;"></div>
			  
	   </div>
	   
	</div>

</div>
    
<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token");

layui.use(['form','table','laydate','element'],function(){
	var form = layui.form,table=layui.table,laydate=layui.laydate,$ = layui.$,element=layui.element;
	
	laydate.render({
		elem:'#alarmDate',
		type:'date',
		value: getDay(-1)
	})
	
	laydate.render({
		elem:'#alarmStartDate',
		type:'date',
		value: getDay(-2)
	})
	
	laydate.render({
		elem:'#alarmEndDate',
		type:'date',
		value: getDay(-1)
	})
	
	laydate.render({
		elem:'#barDate',
		type:'date',
		value: getDay(-1)
	})
	
	//初始化出车间下拉框
	initWorkshop();
	
	table.render({
		 elem: '#testReload'
        ,cellMinWidth:90
        ,parseData:function(res){ 
        	return parseData(res); //common.js里面
        }
        ,headers:{Authorization:"Bearer "+token}
	    ,cols:[[
	    	{field:'machineId', title:'机台名称',align:'center',minWidth:213}
	       ,{field:'workshop', title:'车间',align:'center',width:87}
	       ,{field:'productType', title:'产品类型',align:'center'}
	       ,{field:'partName', title:'料号',align:'center'}
	       ,{field:'', title:'班次',align:'center',templet:function(d){
	    	   if(d.duty == 0){
	    		   return '<span>白班</span>'
	    	   }
	    	   return '<span style="background-color:black;color:white">晚班</span>'
	       }}
	       ,{field:'', title:'待料时长',align:'center',minWidth:146, templet:function(d){
	    	   if(d.waitDuaration == undefined){
	    		   return 0;
	    	   }
	    	   return secondsFormat(d.waitDuaration);
	       }}
	       ,{field:'', title:'告警停机时长',align:'center',minWidth:146,templet:function(d){
	    	   if(d.stopDuaration == undefined){
	    		   return 0;
	    	   }
	    	   return secondsFormat(d.stopDuaration);
	       }}
	       ,{field:'top1AlarmItem', title:'TOP1告警项',align:'center'}
	       ,{field:'top1AlarmCount', title:'TOP1告警数量',sort:true,align:'center', minWidth:130}
	       ,{field:'top2AlarmItem', title:'TOP2告警项',align:'center'}
	       ,{field:'top2AlarmCount', title:'TOP2告警数量',sort:true,align:'center', minWidth:130}
	       ,{field:'top3AlarmItem', title:'TOP3告警项',align:'center'}
	       ,{field:'top3AlarmCount', title:'TOP3告警数量',sort:true,align:'center', minWidth:130}
	    ]]
	    ,url:'/summary/alarm'
		,limit:30
	    ,page: true
	    ,id:'testReload'
	    ,done:function(res,curr,count){
	    	var paramData = getSearchParamData();
	    	paramData.page = curr;
	    	paramData.limit = res.data.length;
	    	barCharts(paramData); 
	    }
	});
	
	form.on('checkbox(multipart)',function(obj){
		if(obj.elem.checked){
			$('#partNameDiv').removeClass('layui-hide');	
			$('#machineDiv').addClass('layui-hide');	
			
			$('#barDateDiv').removeClass('layui-hide');
			$('#pieDateDiv').addClass('layui-hide');
			return;
		}
		$('#partNameDiv').addClass('layui-hide');	
		$('#machineDiv').removeClass('layui-hide');	
		
		$('#barDateDiv').addClass('layui-hide');
		$('#pieDateDiv').removeClass('layui-hide');
	})
	
	$('#pieSearch').click(function(){
		var multipart = $("#multipart").is(":checked");
		if(multipart){
			var partName = $('#barPartName').val();
			var barDate = $('#barDate').val();
			var paramData = {"partName":partName,"date":barDate};
			paramData.page = 1;
			paramData.limit = 30;
			barCharts(paramData);
			return;
		}
		pieCharts();
	})
	
	function pieCharts(){
		var machineId = $('#pieMachineId').val();
		var alarmStartDate = $('#alarmStartDate').val();
		var alarmEndDate = $('#alarmEndDate').val();
		if(machineId == ''){
			return layer.msg('请填写机台',{icon:0});
		}
		var paramData = {"machineId":machineId,"startDate":alarmStartDate,"endDate":alarmEndDate};
		var seriesData = [],legendData = [];
		$.ajax({
			url:'/alarm/machine/days/total',
			data:paramData,
			type:'get',
			dataType:'json',
			success:function(res){
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
				var data = res.data;
				if(res.status != 200 || data.length == 0){
					layer.msg('没有 '+machineId+' 的数据');
				}else{
					for(var i=0;i<data.length;i++){
						var test = data[i];
						legendData.push(data[i].alarmItem);
						
						seriesData.push({"name":data[i].alarmItem,"value":data[i].alarmCount});
					}
				}
				
				// 基于准备好的dom，初始化echarts实例
			    var myChart = echarts.init(document.getElementById('pieCharts'));
			    var width = $(document.body).width();
			    var height = $(document.body).height()-220;
				myChart.resize({height:height,width:width})
				myChart.clear(this.option);
				option = {
					    title: {
					        text: machineId + " TOP3告警",
					        left: 'center'
					    },
					    tooltip: {
					        trigger: 'item',
					        formatter: '{a} <br/>{b} : {c} ({d}%)'
					    },
					    legend: {
					        orient: 'vertical',
					        left: 'left',
					        data: legendData
					    }, 
					    series: [
					        {
					            name: '访问来源',
					            type: 'pie',
					            radius: '55%',
					            center: ['50%', '60%'],
					            data: seriesData,
					            emphasis: {
					                itemStyle: {
					                    shadowBlur: 10,
					                    shadowOffsetX: 0,
					                    shadowColor: 'rgba(0, 0, 0, 0.5)'
					                }
					            }
					        }
					    ]
					};
				
				 myChart.setOption(option);
				
			}
		})
		
	}
	
	function barCharts(paramData){
		var workArea = $('#workArea').val();
		var legendData = [],xData = [],seriesData = [];
		 seriesData[0] = {'name':[],'type':'bar','data':[]};
		 seriesData[1] = {'name':[],'type':'bar','data':[]};
		 seriesData[2] = {'name':[],'type':'bar','data':[]};
		$.ajax({
			url:'/alarm/machines/day',
			data:paramData,
			type:'get',
			dataType:'json',
			success:function(res){
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
				var data = res.data;
				if(res.status != 200 || data.length  == 0){
					 layer.msg('没有 '+paramData.date+' 的数据');
				}else{
					for(var i=0;i<data.length;i++){
						xData.push(data[i].machineId);
						
						seriesData[0].name.push(data[i].top1AlarmItem+"top1AlarmItem");
						seriesData[0].data.push(data[i].top1AlarmCount);
						
						seriesData[1].name.push(data[i].top2AlarmItem+"top1AlarmItem");
						seriesData[1].data.push(data[i].top2AlarmCount);
						
						seriesData[2].name.push(data[i].top3AlarmItem+"top1AlarmItem");
						seriesData[2].data.push(data[i].top3AlarmCount);
						
						legendData.push(data[i].top1AlarmItem+data[i].top2AlarmItem+data[i].top3AlarmItem)
					}
				}
				
				// 基于准备好的dom，初始化echarts实例
			    var myChart = echarts.init(document.getElementById('pieCharts'),'vintage');
			    var width = $(window).width();
			    var height = $(window).height()-200;
				myChart.resize({height:height,width:width})
				myChart.clear(this.option);
				option = {
					 color: ['#5a98de','#5FB878', '#25303c'],
					 title: {
					        text: paramData.date +" "+workArea+ " TOP3告警",
					        left: 'center'
					 },
				      tooltip: {
				        trigger: 'axis',
				        triggerOn: 'mousemove',
				         enterable:true,//鼠标是否可进入提示框浮层中
				          formatter:formatterHover,//修改鼠标悬停显示的内容
				    },  
				    legend: {
				        orient: 'vertical',
				        left: 'left',
				        data: legendData
				    },
				    grid: {
				        left: '3%',
				        right: '4%',
				        bottom: '3%',
				        containLabel: true
				    },
				    xAxis: [
				        {
				            type: 'category',
				            data: xData,
				            axisLabel: {  
					    		   interval:0,  
					    		   rotate:20  
						    }
				        }
				    ],
				    yAxis: [
				        {
				            type: 'value'
				        }
				    ],
				    series: seriesData
				};
				
				 myChart.setOption(option);
				
			},error:function(){layer.msg('出错了',{icon:0});}
		})
		
	}
	
	//修改鼠标移上去时显示的值
	function formatterHover(params){
		var index = params[0].dataIndex,result = '',count = 0;
		for(var i=0;i<params.length;i++){
			params[i].seriesId = params[i].seriesId.split("top1AlarmItem,")[index];
			params[i].seriesName = params[i].seriesName.split("top1AlarmItem,")[index];
			if(params[i].seriesName == ''){
				continue;
			}
			if(count == 0){
				result += params[i].seriesName+":"+params[i].value;
				count++;
				continue;
			}
			result += "<br>"+params[i].seriesName+":"+params[i].value;
		} 
		return result;
	}
	
	
	//表格重载
	var $ = layui.$, active = {
		reload:function(){
		  var data = getSearchParamData();
		  table.reload('testReload',{
	          where: data
			  ,page: {
		           curr: 1 //重新从第 1 页开始
		      }
		  });
	         
	    }
	}
	
	//获取查询参数
	function getSearchParamData(){
		var workArea = $('#workArea').val(); 
		var workshop = $('#workshop').val(); 
		var alarmDate = $('#alarmDate').val(); 
		var partName = $('#partName').val(); 
		var machineId = $('#machineId').val(),paramData; 
		if(alarmDate != ''){
			paramData = {"workArea":workArea,"date":alarmDate,"partName":partName,"machineId":machineId,"workshop":workshop};
		 }else{
			paramData = {"workArea":workArea,"partName":partName,"machineId":machineId,"workshop":workshop};
		 }
		return paramData;
	}
	
	form.on('select(workArea)',function(){
		initWorkshop();
		var type = "reload";
		active[type] ? active[type].call(this) : '';
	})
	
	form.on('select(workshop)',function(){
		var type = "reload";
		active[type] ? active[type].call(this) : '';
	})
	 
	 $('#partName').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
		 
	 })
	 $('#machineId').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
	 })
	 
	 $('#btnSearch').on('click', function(){
	    var type = $(this).data('type');
	    active[type] ? active[type].call(this) : '';
	 });
	
});
$('layui-laypage-limits select').addClass('lay-filter','limitFilter');
var test = $('select lay-ignore option:selected').text();

function dbtnExcel(){
	var partName = $('#partName').val(); 
	var workshop = $('#workshop').val(); 
	var alarmDate = $('#alarmDate').val(); 
	var workArea = $('#workArea').val(),startDate,endDate;  
	if(alarmDate != ''){
	    window.location.href = '/totalcount/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&date='+alarmDate+'&limit=99990&page=1'
	    return;
	 }
	window.location.href = '/totalcount/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&limit=99990&page=1'
}

</script>
</body>
</html>