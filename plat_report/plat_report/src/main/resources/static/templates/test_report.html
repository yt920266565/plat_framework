<html>
<head>
<meta charset="utf-8">
<title>测试总数分析报表</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">

<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui/css/H-ui.min.css">
<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" href="/static/h-ui/h-ui/css/iconfont.css" media="all"/>
<link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css"  media="all">
<link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
<link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">

<script src="/static/js/jquery.min.js" charset="utf-8"></script>
<script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script src="/static/js/echarts/echarts.min.js" charset="utf-8"></script>
<script src="/static/js/ehartsStyle.js" charset="utf-8"></script>
<script src="/static/templates/common.js" charset="utf-8"></script>
<style type="text/css">
</style>
</head>
<body>

<div class="layui-tab">
	<ul class="layui-tab-title">
		<li class="layui-this">测试总数分析报表</li>
		<li>图表</li>
	</ul>
	
	<div class="layui-tab-content">
	  <div class="layui-tab-item layui-show">
	    <div class="layui-row" style="margin-left: 10px;">
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>机台:</label>
	        <input id="machineId" class="layui-input">
	     </div>
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>料号:</label>
	        <input id="partName" class="layui-input">
	     </div>
	     <div class="layui-col-mid2 layui-col-lg2">
	        <label>日期:</label>
	        <input id="hourDate" class="layui-input">
	     </div>
	     <div class="layui-col-mid5 layui-col-lg6">
				<label>客户区域:</label>
				<form class="layui-form" id="testSelect" style="display: inline-block; width:30%">
					<select class="layui-form" id="workArea" lay-filter="workArea"
						lay-verify="" lay-search>
					</select>
				</form>
				
				<label>车间:</label>
				<form class="layui-form" id="testSelect" style="display: inline-block; width:30%">
					<select class="layui-form" id="workshop" lay-filter="workshop"
						lay-verify="" lay-search>
						<option value="">选择或搜索</option>
					</select>
				</form>
				<button id="btnSearch" data-type="reload" class="btn btn-primary radius">
	            <i class="Hui-iconfont">&#xe665;</i>
	        </button>
	        <button  class="btn btn-primary radius " style="margin-left:10px;"
	        value="导出Excel" onclick="dbtnExcel()">导出Excel</button>
	     </div>
	       <table class="layui-table" lay-filter="demo" id="testReload">
		</table>
	   </div>
	  </div>
	  
	   <div class="layui-tab-item">
		  <div id="mainCharts" style="width: 1500px;height:600px;"></div>
	   </div>
		
	</div>

</div>
    
<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token");
layui.use(['form','table','laydate','element'],function(){
	var form = layui.form,table=layui.table,laydate=layui.laydate,$ = layui.$,element=layui.element;
	
	//初始化出车间下拉框
	initWorkshop();
	
	var html = [],hourData = [],chartData = [];
	html[0] = [];
	html[0][0] = {field:'machineId', title:'机台名称',align:'center',minWidth:213};
	html[0][1] = {field:'workshop', title:'车间',align:'center',width:87};
	html[0][2] = {field:'productType', title:'产品类型',align:'center',minWidth:90};
	html[0][3] = {field:'partName', title:'料号',align:'center', minWidth:90};
	//根据日期，加载日期列
	function getDutyDate(html){
		$.ajax({
			url:'/hour/title',
			type:'get',
			dataType:'json',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			async:false,
			success:function(res){
				for(var i=0;i<res.length;i++){
					if(i == 12 || i == 25){
					  html[0][i+4] = {field:res[i], title:res[i],align:'center',minWidth:'87'};
					}else{
					  html[0][i+4] = {field:res[i], title:res[i],align:'center', minWidth:'70'}
					  chartData.push(res[i]);
					}
					hourData.push(res[i]);
				}
			}
		})
	}
	getDutyDate(html);
	
	//列值改变重新渲染
	table.render({
		 elem: '#testReload'
        ,cellMinWidth:60
        ,headers:{Authorization:"Bearer "+token}
		,parseData:function(res){ 
	       	return parseData(res); //common.js里面
	     }
	    ,url:'/hour/report?isChart=false'
		,limit:30
	    ,cols:html
	    ,page: true
	    ,id:'testReload'
	});
	
	function charts(){
		var seriesData = [],machineData = [],paramData;
		var paramData = getSearchParamData();
		$.ajax({
			url:'/hour/report?isChart=true&page=1&limit=5',
			type:'get',
			data:paramData,
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			dataType:'json',
			success:function(res){
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
		        for(var i=0;i<res.data.length;i++){
					var temp = [];
					for(var j=0;j<chartData.length;j++){
						var temp1 = res.data[i];
						var temp2 = chartData[j];
						temp.push(temp1[temp2]);
						if(j < chartData.length-1){
							continue;
						}
						seriesData.push({"name":res.data[i].machineId,"type":"line","data":temp});
				        machineData.push(res.data[i].machineId);
					}
				}
				// 基于准备好的dom，初始化echarts实例
			    var myChart = echarts.init(document.getElementById('mainCharts'),'roma');
			    myChart.clear(this.option);
			    // 指定图表的配置项和数据
			     var option = {
			        title: {
			            text: '测试总数报表'
			        },
			        tooltip: {},
			        legend: {
			            data : machineData
			        },
			        xAxis: {
			        	type:'category',
			            data: chartData
			        },
			        yAxis: {
			        	type:'value',
			        	interval: 200, //间隔
			        },
			        series: seriesData,
			        label: {
			            show: true
			          }
			    }; 
			    
			    myChart.setOption(option);
			}
		})
	}
	charts();
	
	//表格重载
	var $ = layui.$, active = {
		reload:function(){
		// getDutyDate(html);
		//  tableRender(html);

		  charts();
		  var data = getSearchParamData();
		  table.reload('testReload',{
	          where: data
			  ,page: {
		           curr: 1 //重新从第 1 页开始
		      }
		  });
	         
	    }
	}
	
	//获取查询参数
	function getSearchParamData(){
		var workArea = $('#workArea').val(); 
		var workshop = $('#workshop').val(); 
		var hourDate = $('#hourDate').val(); 
		var partName = $('#partName').val(); 
		var machineId = $('#machineId').val(),paramData; 
		if(hourDate != ''){
			paramData = {"workArea":workArea,"date":hourDate,"partName":partName,"machineId":machineId,"workshop":workshop};
		 }else{
			paramData = {"workArea":workArea,"partName":partName,"machineId":machineId,"workshop":workshop};
		 }
		return paramData;
	}
	
	form.on('select(workArea)',function(){
		initWorkshop();
		var type = "reload";
		active[type] ? active[type].call(this) : '';
	})
	
	form.on('select(workshop)',function(){
		var type = "reload";
		active[type] ? active[type].call(this) : '';
	})
	 
	 $('#partName').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
		 
	 })
	 $('#machineId').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
	 })
	 
	 $('#btnSearch').on('click', function(){
	    var type = $(this).data('type');
	    active[type] ? active[type].call(this) : '';
	 });
	
	laydate.render({
		elem:'#hourDate',
		type:'date',
		value: getDay(-1)
	})
	
});

function dbtnExcel(){
	var partName = $('#partName').val(); 
	var workshop = $('#workshop').val(); 
	var hourDate = $('#hourDate').val(); 
	var workArea = $('#workArea').val(),startDate,endDate;  
	if(hourDate != ''){
	    window.location.href = '/totalcount/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&date='+hourDate+'&limit=99990&page=1'
	    return;
	 }
	window.location.href = '/totalcount/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&limit=99990&page=1'
}

</script>
</body>
</html>