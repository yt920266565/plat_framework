<html>
<head>
<meta charset="utf-8">
<title>TOP3不良分析报表</title>
<meta name="renderer" content="webkit">
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
<meta name="viewport"
	content="width=device-width, initial-scale=1, maximum-scale=1">
 <link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui/css/H-ui.min.css">
 <link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">
  <link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui.admin/css/H-ui.admin.css" />
  <link rel="stylesheet" href="/static/h-ui/h-ui/css/iconfont.css" media="all"/>
  <link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css"  media="all">
  <link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet"/>
  <link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">
            
  <script src="/static/js/jquery.min.js" charset="utf-8"></script>
  <script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
  <script src="/static/js/echarts/echarts.min.js" charset="utf-8"></script>
  <script src="/static/js/ehartsStyle.js" charset="utf-8"></script>
   <script src="/static/templates/common.js" charset="utf-8"></script>
<style type="text/css">
</style>
</head>
<body>
<div class="layui-tab">
   <ul class="layui-tab-title">
	 <li class="layui-this">TOP3不良分析报表</li>
  </ul>
  
  <div class="layui-tab-content">
			<div class="layui-tab-item layui-show">
    <div class="layui-row" style="margin-left:10px">
      <div class="layui-col-mid2 layui-col-lg2">
         <label>机台:</label>
         <input id="machineId" class="layui-input">
      </div>
      <div class="layui-col-mid2 layui-col-lg2">
         <label>料号:</label>
         <input id="partName" class="layui-input">
      </div>
      <div class="layui-col-mid2 layui-col-lg2">
         <label>日期:</label>
         <input id="badDate" class="layui-input">
      </div>
      <div class="layui-col-mid5 layui-col-lg6">
         <label>客户区域:</label>
         <form class="layui-form" id="badSelect" style="display: inline-block; width:30%">
	        <select class="layui-form" id="workArea" lay-filter="workArea" lay-verify="" lay-search>
	        </select>
         </form>
         <label>车间:</label>
         <form class="layui-form" id="badSelect" style="display: inline-block; width:30%">
	        <select class="layui-form" id="workshop" lay-filter="workshop" lay-verify="" lay-search>
	              <option value="">请选择或搜索</option>
	        </select>
         </form>
         <button id="btnSearch" data-type="reload"
             class="btn btn-primary radius">
             <i class="Hui-iconfont">&#xe665;</i>
         </button>
         <button  class="btn btn-primary radius "
         value="导出Excel" style="margin-left:10px;" onclick="dbtnExcel()">导出Excel</button>
      </div>
        <table class="layui-table" lay-filter="demo" id="testReload">
		</table>
   </div>
			</div>

			<div class="layui-tab-item">
			<div id="main" style="width: 1500px;height:600px;"></div>
			   <!--  <div id="main" style="width: 600px;height:400px;"></div> -->
			</div>
		</div>
	</div>
<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token");
layui.use(['form','table','laydate','element'],function(){
	var form = layui.form,table=layui.table,laydate=layui.laydate,$ = layui.$,element=layui.element;
	//初始化出车间下拉框
	initWorkshop();
	
	var html = [],dayDate = [];
	html[0] = [];
	html[0][0] = {field:'machineId', title:'机台名称',align:'center',minWidth:213};
    html[0][1] = {field:'workshop', title:'车间',align:'center',width:87};
	html[0][2] = {field:'productType', title:'产品类型',align:'center',minWidth:90};
	html[0][3] = {field:'partName', title:'料号',align:'center', minWidth:90};

	//根据日期，加载日期列
	function getDutyDate(html){
		var paramData = getSearchParamData();
		dayDate = [];
		for(var i=4;i<html[0].length;i++){
			if(html[0][i] != ''){
				html[0][i] = '';
			}
		}
		$.ajax({
			url:'/day/title',
			type:'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			data:paramData,
			dataType:'json',
			async:false,
			success:function(res){
				var count = 0;
				for(var i=0;i<res.length;i++){
					html[0][i+4] = {field:res[i], title:res[i],align:'left',minWidth:180}
					dayDate.push(res[i]);
				}
			}
		})
	}
	getDutyDate(html);
	
	function tableRender(html){
		var paramData = getSearchParamData();
		table.render({
			elem: '#testReload'
	        ,cellMinWidth:87
	        ,headers:{Authorization:"Bearer "+token}
			,parseData:function(res){ 
		       	return parseData(res); //common.js里面
		     }
		    ,url:'/day/report'
		    ,cols:html
		    ,where:paramData
		    ,page: true
		    ,id:'testReload'
		});
	}
	tableRender(html);
	
	function charts(){
		var data = [],machineData = [];
		var paramData = getSearchParamData();
		$.ajax({
			url:'/day/report?page=0&limit=5',
			type:'get',
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			data: paramData,
			dataType:'json',
			success:function(res){
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
				for(var i=0;i<res.data.length;i++){
					var temp = [];
					var ngName = [];
					var ngNumber = [];
					for(var j=0;j<dayDate.length;j++){
						var temp1 = res.data[i],temp2 = dayDate[j];
						var temp3 = temp1[temp2].split("<br>");
						for(var k=0;k<temp3.length;k++){
							var name = temp3[k].replace(/\(\d+\)$/g,"");
							var number = temp3[k].replace(name,"").replace("(","").replace(")","");
							ngName.push(name);
							ngNumber.push(parseInt(number));
						}
						if(j < dayDate.length-1){
							continue;
						}
						 for(var z=0;z<ngNumber.length;z++){
						  var zdata = [];
						  zdata.push(ngNumber[z]);
				          data.push( {"name":res.data[i].machineId,"type":'bar',"data":zdata});
				          zdata = [];
						} 
					}
				          machineData.push(res.data[i].machineId);
				}
				// 基于准备好的dom，初始化echarts实例
			    var myChart = echarts.init(document.getElementById('main'),'roma');
			    myChart.clear(this.option);
				option = {
				    tooltip: {
				        trigger: 'axis',
				        axisPointer: {            // 坐标轴指示器，坐标轴触发有效
				            type: 'shadow'        // 默认为直线，可选为：'line' | 'shadow'
				        }
				    },
				    legend: {
				        data: machineData
				    },
				    xAxis: {
				        type: 'category',
				        data: dayDate
				    },
				    yAxis: {
				        type: 'value',
				    },
				    series: data
				};
				
				myChart.setOption(option);
			}
		});
		
	}
	charts();
	
	//表格重载
	var $ = layui.$, active = {
		reload:function(){
		  getDutyDate(html);
		  tableRender(html);
		  charts();
	    } 
	}
	
	//获取查询参数
	function getSearchParamData(){
		  var workArea = $('#workArea').val(); 
		  var workshop = $('#workshop').val(); 
		  var badDate = $('#badDate').val(); 
		  var partName = $('#partName').val(); 
		  var machineId = $('#machineId').val(),data = ''; 
		  if(badDate != ''){
			  startDate = badDate.split("~")[0].trim();
			  endDate = badDate.split("~")[1].trim();
			  data = {"workArea":workArea,"startDate":startDate,"workshop":workshop,
			          "endDate":endDate,"partName":partName,"machineId":machineId};
		  }else{
			  data = {"workshop":workshop,"workArea":workArea,"partName":partName,"machineId":machineId};
		  }
		  return data;
	}
	
	form.on('select(workArea)',function(){
		initWorkshop();
		var type = "reload";
		active[type] ? active[type].call(this) : '';
	})
	
	form.on('select(workshop)',function(){
			var type = "reload";
			active[type] ? active[type].call(this) : '';
	})
	 
	 $('#partName').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
	 })
	 $('#machineId').bind('keyup',function(event){
		 if(event.keyCode == '13'){
			 active['reload'].call(this);
		 }
	 })
	 $('#btnSearch').on('click', function(){
	    var type = $(this).data('type');
	    active[type] ? active[type].call(this) : '';
	 });

    var startTime = getDay(-7);
    var endTime = getDay(-1);
	
	laydate.render({
		elem:'#badDate',
		type:'date',
		range:'~',
		value: startTime + ' ~ ' + endTime
	})
});

	
//导出数据
function dbtnExcel(){
	var partName = $('#partName').val(); 
	var machineId = $('#machineId').val(); 
	var badDate = $('#badDate').val(); 
	var workshop = $('#workshop').val(); 
	var workArea = $('#workArea').val(),paramData,startDate,endDate;  
	if(badDate != ''){
		startDate = badDate.split("~")[0].trim();
		endDate = badDate.split("~")[1].trim();
	    window.location.href = '/top3/excel?workArea='+workArea+'&workshop='+workshop+'&partName='+partName+'&startDate='+startDate+'&endDate='+endDate+'&machineId='+machineId+'&limit=99990&page=1'
	    return;
	 }
	window.location.href = '/top3/excel?workArea='+workArea+'&workshop='+workshop+'partName='+partName+'&limit=99990&page=1'
}

</script>
</body>
</html>
