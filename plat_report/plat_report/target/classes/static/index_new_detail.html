<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>首页详情</title>
<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui/css/H-ui.min.css">
<link rel="stylesheet" type="text/css" href="/static/h-ui/h-ui.admin/css/H-ui.admin.css" />
<link rel="stylesheet" href="/static/h-ui/h-ui/css/iconfont.css "media="all" />
<link rel="stylesheet" href="/static/layui-v2.5.6/layui/css/layui.css "media="all">
<link href="/static/layui-v2.5.6/layui/css/modules/layer/default/layer.css" rel="stylesheet" />
<link rel="stylesheet" type="text/css" href="/static/css/smallTable.css">
<script src="/static/js/jquery.min.js" charset="utf-8"></script>
<script src="/static/layui-v2.5.6/layui/layui.js" charset="utf-8"></script>
<script src="/static/js/echarts/echarts.min.js" charset="utf-8"></script>
<script src="/static/templates/common.js" charset="utf-8"></script>
</head>
<style type="text/css">

.layui-card-body {
	font-size: 20px;
}

body {
	color: white;
}

.test {
	background-color:transparent;
	color: white;
}

#min_title_list{
    background-color: rgb(30, 41, 64);
}

.layui-card-header {
    color: white;
    border-bottom: 0px;
}

.layui-card:last-child {
    background-color: transparent;
    border: 1px solid;
}

.small{
	width:40%
}

.layui-form-select dl {
    color: black;
} 

.layui-form-select .layui-input {
    background-color: transparent;
    color:white;
    width:100%;
}

.test-layer-msg{
	background-color: transparent;
    color:white;
}
}

</style>
<body background="/static/images/MapCache.jpg" >

	<div style="text-align: center;font-size: 30px;">智能化运维分析系统</div>

<div style="padding: 20px;  text-align: center;margin-top:10px;">
		<div id="addWorkArea" class="layui-row layui-col-space15">
			<!-- <div class="layui-col-md4 layui-col-lg4">
				<div class="layui-card">
					<div class="layui-card-header">苏州维信机台</div>
					<div id="SuArea" class="layui-card-body">0</div>
				</div>
			</div>

			<div class="layui-col-md4 layui-col-lg4">
				<div class="layui-card">
					<div class="layui-card-header">盐城维信</div>
					<div id="YanArea" class="layui-card-body">0</div>
				</div>
			</div>

			<div class="layui-col-md4 layui-col-lg4">
				<div class="layui-card">
					<div class="layui-card-header">松岗</div>
					<div id="SongArea" class="layui-card-body">0</div>
				</div>
			</div> -->
		</div>
	</div>

	<div class="layui-row layui-col-space5" style="margin-top:10px;">
		<div class="layui-col-mid2 layui-col-lg2">
			<label  style="margin-left:5px">日期:</label>
			<input id="startDate"  class="layui-input test small">~
			<input id="endDate"   class="layui-input test small">
		</div>

		<div class="layui-col-mid5 layui-col-lg5">
			<label>客户区域:</label>
			<form class="layui-form" style="display:inline-block;">
				<select id="workArea" lay-filter="workArea" lay-search="">
				</select>
			</form>

			<label>产品类型:</label>
			<form class="layui-form" style="display:inline-block;" >
				<select id="productType" lay-filter="productType"  lay-search="">
				</select>
			</form>
		</div>

		<div class="layui-col-mid5 layui-col-lg5" >
			<label>料号:</label>
			<form class="layui-form" style="display:inline-block;" >
				<select id="partName" lay-filter="partName"  lay-search="">
				</select>
			</form>

			<label>测试类型:</label>
			<form class="layui-form" style="display:inline-block;" >
				<select id="testType" lay-filter="testType"  lay-search="">
				</select>
			</form>

			<button id="btnSearch" data-type="reload"
					class="btn btn-primary radius">
				<i class="Hui-iconfont">&#xe665;</i>
			</button>
		</div>
	</div>

	<div id="main" style="margin-top:10px;"></div>

</body>

<script type="text/javascript">
var storage=window.localStorage;
var token = storage.getItem("token");
//获取所有的客户区域,所有页面客户区域的初始化都在commn.js的initWorkArea()
var areaNames = [];
layui.use([ 'form', 'laydate' ], function() {
	var form = layui.form, laydate = layui.laydate, $ = layui.$;
	
	//初始化要显示的客户区域以及对应的机台数量
	$.ajax({
		url:'/index/workarea',
		type:'get',
		dataType:'json',
		success:function(res){
			if(res.status != 200 || areaNames == ''){
				return;
			}
			var areaCount = res.data,appendHtml = '';
			
			for(var i=0;i<areaNames.length;i++){
				var temp = 0;
				for(var j=0;j<areaCount.length;j++){
					if(areaNames[i] == areaCount[j].workArea){
						if(areaNames.length == 1){
							appendHtml += '<div class="layui-col-md4 layui-col-lg4 layui-col-md-offset4">'
								 +'	<div class="layui-card">'
								 +'	<div class="layui-card-header">'+areaNames[i]+'</div>'
								 +'     <div  class="layui-card-body">'+areaCount[j].machineCount+'</div>'
								 +'	</div> </div>';
							$("#addWorkArea").append(appendHtml); 
				    		return;
						}
						
						appendHtml += '<div class="layui-col-md4 layui-col-lg4">'
							 +'	<div class="layui-card">'
							 +'	<div class="layui-card-header">'+areaNames[i]+'</div>'
							 +'     <div  class="layui-card-body">'+areaCount[j].machineCount+'</div>'
							 +'	</div> </div>';
					    break;
					}
					temp++;
				}
				
				if(temp == areaCount.length){
					appendHtml += '<div class="layui-col-md4 layui-col-lg4">'
						 +'	<div class="layui-card">'
						 +'	<div class="layui-card-header">'+areaNames[i]+'</div>'
						 +'     <div  class="layui-card-body">0</div>'
						 +'	</div> </div>'
				}
			}
			$("#addWorkArea").append(appendHtml);
			
		}
	})
	
	function initProduct(){
		var workArea = $('#workArea').val();
		$.ajax({
			url:'/index/productTypes',
			type:'get',
			data:{"workArea":workArea},
			async:false,
			dataType:'json',
			success:function(res){
				if(res.status != 200){
					return;
				}
				$('#productType option').remove();
				var resdata = res.data;
				for(var i=0;i<resdata.length;i++){
					if(resdata[i] == 'DOCK'){
						$('#productType').append('<option selected value='+resdata[i]+'>'+resdata[i]+'</option>')
					}else{
						$('#productType').append('<option  value='+resdata[i]+'>'+resdata[i]+'</option>')
					}
				}
				form.render('select'); //layui下拉框需要加这个
			}
		})
	}
	initProduct();

	function initPartName(){
		var workArea = $('#workArea').val();
		$.ajax({
			url:'/index/partNames',
			type:'get',
			data:{"workArea":workArea},
			async:false,
			dataType:'json',
			success:function(res){
				if(res.status != 200){
					return;
				}
				$('#partName option').remove();
				$('#partName').append('<option  value="">请选择</option>');
				var resdata = res.data;
				for(var i=0;i<resdata.length;i++){
					$('#partName').append('<option  value='+resdata[i]+'>'+resdata[i]+'</option>')
				}
				form.render('select'); //layui下拉框需要加这个
			}
		})
	}
	initPartName();

	function initTestType(){
		var workArea = $('#workArea').val();
		$.ajax({
			url:'/index/testTypes',
			type:'get',
			data:{"workArea":workArea},
			async:false,
			dataType:'json',
			success:function(res){
				if(res.status != 200){
					return;
				}
				$('#testType option').remove();
				$('#testType').append('<option  value="">请选择</option>');
				var resdata = res.data;
				for(var i=0;i<resdata.length;i++){
					$('#testType').append('<option  value='+resdata[i]+'>'+resdata[i]+'</option>')
				}
				form.render('select'); //layui下拉框需要加这个
			}
		})
	}
	initTestType();
	
	//监听区域改变，修改产品下拉框的值
	form.on('select(workArea)',function(){
		initProduct();
		initPartName();
		initTestType();
		charts();
	})
	
	form.on('select(productType)',function(){
		charts();
	})

	form.on('select(partName)',function(){
		charts();
	})

	form.on('select(testType)',function(){
		charts();
	})

	$('#btnSearch').click(function(){
		var startDate = $('#startDate').val();
		var endDate = $('#endDate').val();
		var day = getDaysBetween(startDate, endDate);
		if (day > 14){
			layer.msg('起始日期不能超过14天');
			return;
		}
		charts();
	})
	
	function getParamData(){
		var productType = $('#productType').val();
		var startDate = $('#startDate').val();
		var endDate = $('#endDate').val();
		var workArea = $('#workArea').val();
		var partName = $('#partName').val();
		var testType = $('#testType').val();
		return {"productType":productType,"startDate":startDate,"endDate":endDate,"workArea":workArea,"partName":partName,"testType":testType}
	}
		
	function charts() {
		$.ajax({
			url:'/index/passcount',
			type:'get',
			async:false,
			beforeSend:function(request){
				request.setRequestHeader("Authorization","Bearer "+token);
			},
			data:getParamData(),
			dataType:'json',
			success:function(res){
				var resdata = res.data,xdata = [],ydataCnt = [],ydataRatio = [],ydataSum = [];
				if(res.status == 403){
					return layer.msg('没有权限!');
				}
				if(res.status == 401){
					return layer.msg('请先登录!');
				}
				if(res.status != 200 || resdata.length == 0){
				   layer.msg('没有相关的数据!');
				}else{
					for(var i=0;i<resdata.length;i++){
						xdata.push(resdata[i].dutyDate);
						ydataCnt.push(resdata[i].firstPassCount);
						ydataRatio.push(resdata[i].firstPassRatio);
						ydataSum.push(resdata[i].totalCount);
					}
				}
				// 基于准备好的dom，初始化echarts实例
			    var myChart = echarts.init(document.getElementById('main'),'roma');
			    var width = $(document.body).width();
			    var height = $(document.body).height()-230;
				myChart.resize({height:height,width:width})
			    myChart.clear(this.option);
				// 指定图表的配置项和数据
				option = {
					tooltip : {
						trigger : 'axis',
						axisPointer : {
							type : 'cross',
							crossStyle : {
								color : '#999'
							}
						}
					},
					toolbox : {
						feature : {
							restore : {
								show : true
							},
							saveAsImage : {
								show : true
							}
						}
					},
					legend : {
						textStyle:{
                            color: 'white'//字体颜色
                        },
						data : [ '测试总数','首次通过总数', '首次良率']
					},
					xAxis : [ {
						type : 'category',
						data : xdata,
						axisPointer : {
							type : 'shadow'

						},
						axisLabel: {
                            show: true,
                            textStyle: {
                                color: 'white'
                            }
                        },
                        axisLine:{
                            lineStyle:{
                                color:'white',
                            }
                        },
	                    splitLine:{
	                    	show:false
	                    }
                    }],
					yAxis : [ {
						type : 'value',
						name : '首次通过总数',
						axisLabel : {
							formatter : '{value}',
							textStyle: {
                                color: 'white'
                            }
						},
						axisLine:{
	                        lineStyle:{
	                            color:'white'
	                        }
	                    },
	                    splitLine:{
	                    	show:false
	                    }
						
					}, {
						type : 'value',
						name : '首次良率',
						min : 0,
						max : 100,
						axisLabel : {
							formatter : '{value} %',
							textStyle: {  
                                color: 'white' //设置Y轴坐标上的刻度值的颜色
                            }
						},
						axisLine:{
	                        lineStyle:{  //设置Y轴坐标轴颜色
	                            color:'white',
	                        }
	                    },
	                    splitLine:{  //隐藏Y轴的虚线
	                    	show:false
	                    }
					} ],
					series : [
							{
								name : '测试总数',
								type : 'bar',
								data : ydataSum,
								label: {
					                show: true,
					                position: 'top',
					                color: 'white'
					            },
					            itemStyle: { 
					            	normal: {
					            		color:'#41ca67' //设置柱状图颜色
					            	}
					            }
							},
							{
								name : '首次通过总数',
								type : 'bar',
								data : ydataCnt,
								label: {
					                show: true,
					                position: 'top',
					                color: 'white'
					            },
					            itemStyle: { 
					              normal: {
					            	  color:'rgb(90, 152, 222)'
					              }
						        } 
							},
							{
								name : '首次良率',
								type : 'line',
								yAxisIndex : 1,
								data : ydataRatio,
								label: {
					                show: true,
					                position: 'top',
					                color: 'white'
					            },
								itemStyle: { //设置折线图颜色
					              normal: {
					            	lineStyle: {
					            		color:'#5a98de'
					            	}
					              }
						        } 
							} ]
				};
				myChart.setOption(option);
			},error:function(){
				return layer.msg('系统出错了，请刷新重试 !');
			}
		});
		
	}
	charts();

	laydate.render({
		elem : '#endDate',
		type : 'date',
		value : getDay(-1),
	})
	laydate.render({
		elem : '#startDate',
		type : 'date',
		value : getDay(-7),
	})

	function getDaysBetween(dateString1, dateString2){
	   var startDate = Date.parse(dateString1);
	   var endDate = Date.parse(dateString2);
	   var days = (endDate - startDate)/(1*24*60*60*1000);
	   return  days;
	}
	
})
</script>

</html>